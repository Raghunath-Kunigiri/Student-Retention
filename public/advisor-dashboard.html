<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Advisor Dashboard - Student Retention System</title>
  <link rel="stylesheet" href="../src/styles/variables.css" />
  <link rel="stylesheet" href="../src/styles/cursor.css" />
  <link rel="stylesheet" href="../src/styles/interactions.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; 
      background: linear-gradient(135deg, rgba(107,114,128,.1) 0%, rgba(156,163,175,.1) 100%), url('../Images/advisors-advising-students.png') center / cover no-repeat fixed; 
      min-height: 100vh; 
      color: #1f2937; 
    }
    .dashboard { 
      background: rgba(255,255,255,.95); 
      backdrop-filter: blur(10px); 
      border-radius: 20px; 
      padding: 28px; 
      box-shadow: 0 20px 40px rgba(0,0,0,.12); 
      width: 100%; 
      max-width: 1400px; 
      margin: 24px auto;
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 30px; 
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    .title { display: flex; gap: 12px; align-items: center; }
    .avatar { 
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      background: linear-gradient(135deg,#6b7280,#9ca3af); 
      color: #fff; 
      display: grid; 
      place-items: center; 
      font-weight: 700; 
      box-shadow: 0 6px 16px rgba(107,114,128,.35); 
    }
    .header h1 { font-size: 24px; color: #1f2937; }
    .header .meta { color: #6b7280; font-size: 14px; margin-top: 2px; }
    .signout { 
      color: #6b7280; 
      text-decoration: none; 
      font-weight: 700; 
      padding: 12px 16px; 
      border-radius: 10px; 
      background: rgba(107,114,128,.08); 
      transition: all 0.3s ease;
    }
    .signout:hover { background: rgba(107,114,128,.15); }
    
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e5e7eb;
    }
    .nav-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    .nav-tab.active {
      background: #6b7280;
      color: white;
    }
    .nav-tab:hover:not(.active) {
      background: rgba(107,114,128,.1);
    }
    
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 24px; 
    }
    .grid-3 { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 20px; 
    }
    .card { 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.06); 
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,.1);
    }
    .card h2 { 
      font-size: 20px; 
      margin-bottom: 16px; 
      color: #1f2937; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-icon {
      width: 24px;
      height: 24px;
      background: #6b7280;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: linear-gradient(135deg, #6b7280, #9ca3af);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-card.clickable {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .stat-card.clickable:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .list { display: grid; gap: 12px; }
    .list-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 16px; 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      background: #f9fafb; 
      transition: all 0.3s ease;
    }
    .list-item:hover {
      background: #f3f4f6;
      border-color: #6b7280;
    }
    .student-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .student-name {
      font-weight: 600;
      color: #1f2937;
    }
    .student-details {
      font-size: 14px;
      color: #6b7280;
    }
    .chip { 
      padding: 6px 12px; 
      border-radius: 999px; 
      font-size: 12px; 
      font-weight: 600;
    }
    .chip.success { background: #dcfce7; color: #166534; }
    .chip.warning { background: #fef3c7; color: #92400e; }
    .chip.danger { background: #fee2e2; color: #991b1b; }
    .chip.info { background: #dbeafe; color: #1e40af; }
    
    .form { display: grid; gap: 16px; }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    input, select, textarea { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid #e5e7eb; 
      border-radius: 12px; 
      background: #fff; 
      font-size: 14px; 
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #6b7280;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .actions { 
      display: flex; 
      justify-content: flex-end; 
      gap: 12px; 
      margin-top: 20px;
    }
    .btn { 
      border: 0; 
      border-radius: 12px; 
      padding: 12px 20px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .btn.primary { 
      background: linear-gradient(135deg,#6b7280,#9ca3af); 
      color: #fff; 
      box-shadow: 0 8px 20px rgba(107,114,128,.3); 
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(107,114,128,.4);
    }
    .btn.secondary {
      background: #f3f4f6;
      color: #6b7280;
      border: 2px solid #e5e7eb;
    }
    .btn.secondary:hover {
      background: #e5e7eb;
    }
    .btn.danger {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #fecaca;
    }
    .btn.danger:hover {
      background: #fecaca;
    }
    
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .search-bar input {
      flex: 1;
    }
    .search-bar select {
      width: 200px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }
    
    @media (max-width: 900px){ 
      .grid { grid-template-columns: 1fr; } 
      .form-row { grid-template-columns: 1fr; }
      .nav-tabs { flex-wrap: wrap; }
      .search-bar { flex-direction: column; }
      .search-bar select { width: 100%; }
    }
  </style>
  <link rel="stylesheet" href="styles/theme.css" />
  <script type="module" src="../src/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentAdvisor = null;
    let students = [];
    let courses = [];
    let enrollments = [];
    
    // API Configuration
    const API_BASE_URL = window.location.origin;

    document.addEventListener('DOMContentLoaded', async () => {
      console.log('DOM Content Loaded - Initializing dashboard...');
      
      try {
        await loadAdvisorData();
        console.log('Advisor data loaded');
        
        await loadStudents();
        console.log('Students loaded:', students.length);
        
        await loadCourses();
        console.log('Courses loaded:', courses.length);
        
        await loadEnrollments();
        console.log('Enrollments loaded:', enrollments.length);
        
        await updateDashboard();
        console.log('Dashboard updated');
        
        setupEventListeners();
        console.log('Event listeners set up');
        
        console.log('Dashboard initialization complete');
      } catch (error) {
        console.error('Error initializing dashboard:', error);
      }
    });

    async function loadAdvisorData() {
      const advisorId = localStorage.getItem('advisorId');
      if (advisorId) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/data/advisors/${advisorId}`);
          if (response.ok) {
            currentAdvisor = await response.json();
            updateHeader();
          }
        } catch (error) {
          console.error('Error loading advisor data:', error);
        }
      }
    }

    async function loadStudents() {
      try {
        // Fetch students from CSV files
        const response = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (response.ok) {
          const data = await response.json();
          students = Array.isArray(data) ? data : [];
          console.log('Students data from CSV:', students.length, 'students loaded');
        } else {
          console.error('Failed to load students:', response.status);
          students = [];
        }
      } catch (error) {
        console.error('Error loading students:', error);
        students = [];
      }
    }

    async function loadFilteredStudents() {
      try {
        const sortBy = document.getElementById('sort-by').value;
        const sortOrder = document.getElementById('sort-order').value;
        const department = document.getElementById('department-filter').value;
        const year = document.getElementById('year-filter').value;
        const enrollmentStatus = document.getElementById('status-filter').value;
        const search = document.getElementById('student-search').value;

        const params = new URLSearchParams({
          sortBy,
          sortOrder,
          ...(department && { department }),
          ...(year && { year }),
          ...(enrollmentStatus && { enrollmentStatus }),
          ...(search && { search })
        });

        const response = await fetch(`${API_BASE_URL}/api/data/students/detailed?${params}&limit=2000`);
        if (response.ok) {
          const data = await response.json();
          students = Array.isArray(data) ? data : [];
          console.log('Filtered students:', students.length, 'students loaded');
          updateStudentList();
          updateFilterResults();
        } else {
          console.error('Failed to load filtered students:', response.status);
        }
      } catch (error) {
        console.error('Error loading filtered students:', error);
      }
    }

    function updateFilterResults() {
      const resultsSpan = document.getElementById('filter-results');
      if (resultsSpan) {
        resultsSpan.textContent = `Showing ${students.length} students`;
      }
    }

    async function loadCourses() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/courses`);
        if (response.ok) {
          const data = await response.json();
          courses = Array.isArray(data) ? data : [];
          console.log('Courses data:', courses.length, 'courses loaded');
          // Refresh UI after loading courses from CSV
          updateCourseList();
        } else {
          console.error('Failed to load courses:', response.status);
          courses = [];
        }
      } catch (error) {
        console.error('Error loading courses:', error);
        courses = [];
      }
    }

    async function loadEnrollments() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/enrollments`);
        if (response.ok) {
          const data = await response.json();
          enrollments = Array.isArray(data) ? data : [];
          console.log('Enrollments data:', enrollments.length, 'enrollments loaded');
        } else {
          console.error('Failed to load enrollments:', response.status);
          enrollments = [];
        }
      } catch (error) {
        console.error('Error loading enrollments:', error);
        enrollments = [];
      }
    }

    function updateHeader() {
      if (currentAdvisor) {
        const initials = `${currentAdvisor.firstName[0]}${currentAdvisor.lastName[0]}`.toUpperCase();
        document.getElementById('welcome').textContent = `Welcome, ${currentAdvisor.firstName} ${currentAdvisor.lastName}`;
        document.getElementById('advisor-id-line').textContent = `ID: ${currentAdvisor.advisorId} â€¢ ${currentAdvisor.department}`;
        document.getElementById('avatar').textContent = initials;
      }
    }

    async function updateDashboard() {
      await updateStats();
      updateStudentList();
      updateRecentActivity();
      updateCourseList();
      // Render charts if analytics tab already visible
      maybeRenderAnalyticsCharts();
    }
    
    function updateCourseList() {
      // Ensure courses is an array
      if (!Array.isArray(courses)) {
        console.warn('Courses data is not an array:', courses);
        courses = [];
      }
      
      const courseList = document.getElementById('course-list');
      if (!courseList) return;
      
      courseList.innerHTML = '';
      
      courses.forEach(course => {
        const courseItem = document.createElement('div');
        courseItem.className = 'list-item';
        courseItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${course.course_title || course.courseName || 'No title'}</div>
            <div class="student-details">${course.course_code || course.courseCode || 'No code'} â€¢ ${course.department || 'No department'} â€¢ ${course.credits || 'No credits'} credits</div>
            ${course.description ? `<div class="course-description">${course.description}</div>` : ''}
          </div>
          <span class="chip success">Active</span>
        `;
        courseList.appendChild(courseItem);
      });
    }

    async function updateStats() {
      try {
        // Fetch statistics from CSV-based endpoint
        const response = await fetch(`${API_BASE_URL}/api/data/csv-stats`);
        if (response.ok) {
          const stats = await response.json();
          
          console.log('CSV Stats loaded:', stats);

          document.getElementById('total-students').textContent = stats.totalStudents;
          document.getElementById('at-risk-students').textContent = stats.atRiskStudents;
          document.getElementById('avg-gpa').textContent = stats.averageGPA.toFixed(2);
          document.getElementById('active-enrollments').textContent = stats.activeEnrollments;
          const rrEl = document.getElementById('retention-rate');
          if (rrEl) rrEl.textContent = `${stats.retentionRate}%`;
        } else {
          console.error('Failed to load CSV stats:', response.status);
          // Fallback to 0 values
          document.getElementById('total-students').textContent = '0';
          document.getElementById('at-risk-students').textContent = '0';
          document.getElementById('avg-gpa').textContent = '0.00';
          document.getElementById('active-enrollments').textContent = '0';
          const rrEl = document.getElementById('retention-rate');
          if (rrEl) rrEl.textContent = '0%';
        }
      } catch (error) {
        console.error('Error loading CSV stats:', error);
        // Fallback to 0 values
        document.getElementById('total-students').textContent = '0';
        document.getElementById('at-risk-students').textContent = '0';
        document.getElementById('avg-gpa').textContent = '0.00';
        document.getElementById('active-enrollments').textContent = '0';
        const rrEl = document.getElementById('retention-rate');
        if (rrEl) rrEl.textContent = '0%';
      }
    }

    function updateStudentList() {
      // Ensure students is an array
      if (!Array.isArray(students)) {
        console.warn('Students data is not an array:', students);
        students = [];
      }
      
      const studentList = document.getElementById('student-list');
      const studentListDetailed = document.getElementById('student-list-detailed');
      
      if (studentList) {
        studentList.innerHTML = '';
      }
      if (studentListDetailed) {
        studentListDetailed.innerHTML = '';
      }

      students.slice(0, 50).forEach(student => {
        // Calculate risk level based on GPA and attendance
        const gpa = student.academic?.gpa || 0;
        const absences = student.academic?.attendanceAbsences || 0;
        const credits = Math.min(student.academic?.creditsEarned || 0, 33); // Cap at 33
        
        let riskLevel = 'success';
        let riskText = 'On Track';
        
        if (gpa < 3.1) {
          riskLevel = 'danger';
          riskText = 'At Risk';
        }
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${student.firstName || student.first_name} ${student.lastName || student.last_name}</div>
            <div class="student-details">
              ID: ${student.studentId || student.student_id} â€¢ ${student.major} â€¢ ${student.year} â€¢ 
              GPA: ${gpa.toFixed(2)} â€¢ Credits: ${credits} â€¢ Absences: ${absences}
            </div>
            <div class="student-contact">
              ðŸ“§ ${student.email} â€¢ ðŸ“ž ${student.phone}
            </div>
            <div class="student-advisor">
              Advisor: ${student.assignedAdvisor ? `${student.assignedAdvisor.firstName} ${student.assignedAdvisor.lastName}` : 'Not Assigned'}
            </div>
          </div>
          <span class="chip ${riskLevel}">${riskText}</span>
        `;
        studentItem.onclick = () => openStudentModal(student);
        
        if (studentList) {
          studentList.appendChild(studentItem.cloneNode(true));
        }
        if (studentListDetailed) {
          studentListDetailed.appendChild(studentItem);
        }
      });
    }

    function updateRecentActivity() {
      const activityList = document.getElementById('activity-list');
      activityList.innerHTML = '';

      // Mock recent activity - in real app, this would come from a database
      const activities = [
        { type: 'enrollment', student: 'John Doe', course: 'CS305', status: 'New', time: '2 hours ago' },
        { type: 'gpa', student: 'Jane Smith', course: 'MATH201', status: 'Updated', time: '4 hours ago' },
        { type: 'risk', student: 'Bob Johnson', course: 'ENG101', status: 'Alert', time: '6 hours ago' }
      ];

      activities.forEach(activity => {
        const activityItem = document.createElement('div');
        activityItem.className = 'list-item';
        activityItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${activity.student}</div>
            <div class="student-details">${activity.course} â€¢ ${activity.time}</div>
          </div>
          <span class="chip ${activity.status === 'Alert' ? 'danger' : activity.status === 'New' ? 'info' : 'warning'}">${activity.status}</span>
        `;
        activityList.appendChild(activityItem);
      });
    }

    function setupEventListeners() {
      console.log('Setting up event listeners...');
      
      // Tab switching
      const navTabs = document.querySelectorAll('.nav-tab');
      console.log('Found nav tabs:', navTabs.length);
      
      navTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Tab clicked:', tab.dataset.tab);
          
          // Remove active class from all tabs and content
          document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
          document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab and corresponding content
          tab.classList.add('active');
          const targetContent = document.getElementById(tab.dataset.tab);
          if (targetContent) {
            targetContent.classList.add('active');
            console.log('Switched to tab:', tab.dataset.tab);
          } else {
            console.error('Target content not found:', tab.dataset.tab);
          }
        });
      });


      // Legacy search functionality (keeping for backward compatibility)
      const studentSearch = document.getElementById('student-search');
      if (studentSearch) {
        studentSearch.addEventListener('input', (e) => {
          // Use the new filtered API instead of client-side filtering
          loadFilteredStudents();
        });
      }

      // Filter controls
      const applyFiltersBtn = document.getElementById('apply-filters');
      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', () => {
          loadFilteredStudents();
        });
      }

      const clearFiltersBtn = document.getElementById('clear-filters');
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
          // Reset all filter controls
          document.getElementById('sort-by').value = 'firstName';
          document.getElementById('sort-order').value = 'asc';
          document.getElementById('department-filter').value = '';
          document.getElementById('year-filter').value = '';
          document.getElementById('status-filter').value = '';
          document.getElementById('risk-filter').value = '';
          document.getElementById('student-search').value = '';
          
          // Reload all students
          loadStudents().then(() => {
            updateStudentList();
            updateFilterResults();
          });
        });
      }

      // Auto-apply filters when dropdowns change
      const filterControls = ['sort-by', 'sort-order', 'department-filter', 'year-filter', 'status-filter', 'risk-filter'];
      filterControls.forEach(id => {
        const control = document.getElementById(id);
        if (control) {
          control.addEventListener('change', () => {
            loadFilteredStudents();
          });
        }
      });

      // Modal close
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.closest('.modal').classList.remove('active');
        });
      });
      
      console.log('Event listeners set up successfully');
      
      // Fallback: Direct click handlers for each tab
      const tabButtons = {
        'overview': () => switchToTab('overview'),
        'students': () => switchToTab('students'),
        'courses': () => switchToTab('courses'),
        'analytics': () => switchToTab('analytics')
      };
      
      // Add direct click handlers
      Object.keys(tabButtons).forEach(tabId => {
        const button = document.querySelector(`[data-tab="${tabId}"]`);
        if (button) {
          button.onclick = (e) => {
            e.preventDefault();
            tabButtons[tabId]();
          };
        }
      });

      // At-risk students card click handler
      const atRiskCard = document.getElementById('at-risk-card');
      if (atRiskCard) {
        atRiskCard.addEventListener('click', openAtRiskModal);
      }
    }
    
    function switchToTab(tabId) {
      console.log('Switching to tab:', tabId);
      
      // Remove active class from all tabs and content
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Add active class to clicked tab and corresponding content
      const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
      const tabContent = document.getElementById(tabId);
      
      if (tabButton && tabContent) {
        tabButton.classList.add('active');
        tabContent.classList.add('active');
        console.log('Successfully switched to tab:', tabId);
      } else {
        console.error('Tab button or content not found:', tabId);
      }
    }

    function updateStudentListWithData(studentData) {
      // Ensure studentData is an array
      if (!Array.isArray(studentData)) {
        console.warn('Student data is not an array:', studentData);
        studentData = [];
      }
      
      const studentList = document.getElementById('student-list');
      if (!studentList) return;
      
      studentList.innerHTML = '';

      studentData.forEach(student => {
        const riskLevel = student.riskScore > 0.7 ? 'danger' : student.riskScore > 0.4 ? 'warning' : 'success';
        const riskText = student.riskScore > 0.7 ? 'At Risk' : student.riskScore > 0.4 ? 'Monitor' : 'On Track';
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${student.firstName || student.first_name} ${student.lastName || student.last_name}</div>
            <div class="student-details">ID: ${student.studentId || student.student_id} â€¢ ${student.major} â€¢ GPA: ${student.academic?.gpa || 'N/A'}</div>
          </div>
          <span class="chip ${riskLevel}">${riskText}</span>
        `;
        studentItem.onclick = () => openStudentModal(student);
        studentList.appendChild(studentItem);
      });
    }


    function openStudentModal(student) {
      document.getElementById('modal-student-name').textContent = `${student.firstName || student.first_name} ${student.lastName || student.last_name}`;
      document.getElementById('modal-student-id').textContent = student.studentId || student.student_id;
      document.getElementById('modal-student-major').textContent = student.major;
      document.getElementById('modal-student-gpa').textContent = student.academic?.gpa || 'N/A';
      document.getElementById('modal-student-year').textContent = student.year;
      document.getElementById('modal-student-status').textContent = student.enrollmentStatus;
      
      document.getElementById('student-modal').classList.add('active');
    }

    function openAddStudentModal() {
      document.getElementById('add-student-modal').classList.add('active');
    }

    function openCourseModal() {
      document.getElementById('course-modal').classList.add('active');
    }

    function openReportModal() {
      document.getElementById('report-modal').classList.add('active');
    }

    async function generateReport() {
      const reportType = document.getElementById('report-type').value;
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      const resultsEl = document.getElementById('report-results');
      if (resultsEl) {
        resultsEl.textContent = 'Generating...';
      }

      if (!startDate || !endDate) {
        if (resultsEl) resultsEl.textContent = 'Please select a valid date range';
        return;
      }

      try {
        if (reportType === 'retention') {
          const url = `${API_BASE_URL}/api/data/csv-retention?start=${startDate}&end=${endDate}`;
          const resp = await fetch(url);
          if (!resp.ok) {
            if (resp.status === 404) {
              const fallback = await fetch(`${API_BASE_URL}/api/data/csv-stats`);
              if (fallback.ok) {
                const stats = await fallback.json();
                if (resultsEl) {
                  const rr = typeof stats.retentionRate === 'number' ? stats.retentionRate : 0;
                  resultsEl.innerHTML = `
                    <div style=\"margin-top:10px\">
                      <div><strong>Range:</strong> ${startDate} â†’ ${endDate}</div>
                      <div><strong>Overall Retention Rate (fallback):</strong> ${rr}%</div>
                      <div style=\"color:#9ca3af\">Date-range endpoint not found (404). Showing overall retention.</div>
                    </div>
                  `;
                }
                return;
              }
            }
            throw new Error(`Failed to generate report (${resp.status})`);
          }
          const data = await resp.json();
          if (resultsEl) {
            // Prefer cohort-based fields if present
            if (typeof data.cohortSize === 'number' && typeof data.retainedCount === 'number') {
              resultsEl.innerHTML = `
                <div style=\"margin-top:10px\">
                  <div><strong>Range:</strong> ${data.start} â†’ ${data.end}</div>
                  <div><strong>Subsequent Window:</strong> ${data.windowDays} days</div>
                  <div><strong>Initial Cohort:</strong> ${data.cohortSize}</div>
                  <div><strong>Students Retained:</strong> ${data.retainedCount}</div>
                  <div><strong>Retention Rate:</strong> ${data.retentionRate}%</div>
                </div>
              `;
            } else {
              // Backward compatibility with earlier response structure
              resultsEl.innerHTML = `
                <div style=\"margin-top:10px\">
                  <div><strong>Range:</strong> ${data.start} â†’ ${data.end}</div>
                  <div><strong>Total Students:</strong> ${data.totalStudents ?? 0}</div>
                  <div><strong>Active Students in Range:</strong> ${data.activeStudentsInRange ?? 0}</div>
                  <div><strong>Retention Rate:</strong> ${data.retentionRate ?? 0}%</div>
                </div>
              `;
            }
          }
        } else {
          // Placeholder for other report types
          if (resultsEl) resultsEl.textContent = `Report ${reportType} is not implemented yet.`;
        }
      } catch (err) {
        if (resultsEl) resultsEl.textContent = `Error: ${err.message}`;
      }
    }

    function openAtRiskModal() {
      const modal = document.getElementById('at-risk-modal');
      modal.classList.add('active');
      loadAtRiskStudents();
    }

    // ---------- Analytics Charts ----------
    let retentionChart, performanceChart, riskChart;

    function maybeRenderAnalyticsCharts() {
      const analyticsTab = document.getElementById('analytics');
      if (analyticsTab && analyticsTab.classList.contains('active')) {
        renderRetentionChart();
        renderPerformanceChart();
        renderRiskChart();
      }
    }

    // Wire nav tabs to render when analytics becomes active
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.nav-tab');
      if (!btn) return;
      const tabId = btn.getAttribute('data-tab');
      if (tabId === 'analytics') {
        // Slight delay to ensure canvas is laid out
        setTimeout(maybeRenderAnalyticsCharts, 0);
      }
    });

    async function renderRetentionChart() {
      const canvas = document.getElementById('retentionChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      // Use overall retention from CSV stats as a gauge-like doughnut
      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-stats`);
        if (!resp.ok) throw new Error('stats fail');
        const stats = await resp.json();
        const rate = typeof stats.retentionRate === 'number' ? stats.retentionRate : 0;

        const data = {
          labels: ['Retained', 'Not Retained'],
          datasets: [{
            data: [rate, Math.max(0, 100 - rate)],
            backgroundColor: ['#10b981', '#e5e7eb'],
            borderWidth: 0
          }]
        };

        if (retentionChart) retentionChart.destroy();
        retentionChart = new Chart(ctx, {
          type: 'doughnut',
          data,
          options: {
            cutout: '70%',
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            }
          }
        });
      } catch (_) { /* ignore */ }
    }

    async function renderPerformanceChart() {
      const canvas = document.getElementById('performanceChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (!resp.ok) throw new Error('students fail');
        const data = await resp.json();

        // GPA bands counts
        const bands = [
          { label: '<2.0', min: -Infinity, max: 2.0 },
          { label: '2.0-2.5', min: 2.0, max: 2.5 },
          { label: '2.5-3.0', min: 2.5, max: 3.0 },
          { label: '3.0-3.5', min: 3.0, max: 3.5 },
          { label: '3.5-4.0', min: 3.5, max: 4.01 }
        ];
        const counts = bands.map(b => 0);
        for (const s of data) {
          const g = s?.academic?.gpa ?? 0;
          for (let i = 0; i < bands.length; i++) {
            const b = bands[i];
            if (g >= b.min && g < b.max) { counts[i]++; break; }
          }
        }

        if (performanceChart) performanceChart.destroy();
        performanceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: bands.map(b => b.label),
            datasets: [{
              label: 'Students',
              data: counts,
              backgroundColor: '#3b82f6'
            }]
          },
          options: {
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false } },
              y: { beginAtZero: true }
            }
          }
        });
      } catch (_) { /* ignore */ }
    }

    async function renderRiskChart() {
      const canvas = document.getElementById('riskChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (!resp.ok) throw new Error('students fail');
        const data = await resp.json();

        // Count at-risk (gpa < 3.1) by major
        const map = new Map();
        for (const s of data) {
          const g = s?.academic?.gpa ?? 0;
          if (g < 3.1) {
            const major = s.major || 'Unknown';
            map.set(major, (map.get(major) || 0) + 1);
          }
        }
        const labels = Array.from(map.keys());
        const values = Array.from(map.values());

        if (riskChart) riskChart.destroy();
        riskChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'At-Risk',
              data: values,
              backgroundColor: '#ef4444'
            }]
          },
          options: {
            indexAxis: 'y',
            plugins: { legend: { display: false } },
            scales: {
              x: { beginAtZero: true },
              y: { grid: { display: false } }
            }
          }
        });
      } catch (_) { /* ignore */ }
    }

    function loadAtRiskStudents() {
      const atRiskList = document.getElementById('at-risk-list');
      atRiskList.innerHTML = '<div class="loading">Loading at-risk students...</div>';
      
      // Filter students with GPA < 3.1
      const atRiskStudents = students.filter(s => {
        const gpa = s.academic?.gpa || 0;
        return gpa < 3.1;
      });
      
      if (atRiskStudents.length === 0) {
        atRiskList.innerHTML = '<div class="no-data">No at-risk students found.</div>';
        return;
      }
      
      atRiskList.innerHTML = '';
      atRiskStudents.forEach(student => {
        const gpa = student.academic?.gpa || 0;
        const absences = student.academic?.attendanceAbsences || 0;
        const credits = Math.min(student.academic?.creditsEarned || 0, 33); // Cap at 33
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${student.firstName || student.first_name} ${student.lastName || student.last_name}</div>
            <div class="student-details">
              ID: ${student.studentId || student.student_id} â€¢ ${student.major} â€¢ ${student.year} â€¢ 
              GPA: ${gpa.toFixed(2)} â€¢ Credits: ${credits} â€¢ Absences: ${absences}
            </div>
            <div class="student-contact">
              ðŸ“§ ${student.email} â€¢ ðŸ“ž ${student.phone}
            </div>
            <div class="student-advisor">
              Advisor: ${student.assignedAdvisor ? `${student.assignedAdvisor.firstName} ${student.assignedAdvisor.lastName}` : 'Not Assigned'}
            </div>
          </div>
          <span class="chip danger">At Risk</span>
        `;
        studentItem.onclick = () => openStudentModal(student);
        atRiskList.appendChild(studentItem);
      });
    }

    function addStudent() {
      const form = document.getElementById('add-student-form');
      const formData = new FormData(form);
      
      // In a real app, this would add the student to the database
      alert('Student added successfully!');
      document.getElementById('add-student-modal').classList.remove('active');
      form.reset();
    }

    function addCourse() {
      const form = document.getElementById('add-course-form');
      const formData = new FormData(form);
      
      // In a real app, this would add the course to the database
      alert('Course added successfully!');
      document.getElementById('course-modal').classList.remove('active');
      form.reset();
    }
  </script>
</head>
<body>
  <canvas id="particle-canvas" style="position:fixed;inset:0;pointer-events:none;z-index:9998;"></canvas>
  <div class="dashboard">
    <div class="header">
      <div class="title">
        <div id="avatar" class="avatar">A</div>
        <div>
          <h1 id="welcome">Welcome, Advisor</h1>
          <div id="advisor-id-line" class="meta">Loading...</div>
          <small>Student Retention Dashboard</small>
        </div>
      </div>
      <a class="signout" href="index.html" onclick="localStorage.clear()">Sign out</a>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="overview">ðŸ“Š Overview</button>
      <button class="nav-tab" data-tab="students">ðŸ‘¥ Students</button>
      <button class="nav-tab" data-tab="courses">ðŸ“š Courses</button>
      <button class="nav-tab" data-tab="analytics">ðŸ“ˆ Analytics</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="total-students">0</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card clickable" id="at-risk-card">
          <div class="stat-number" id="at-risk-students">0</div>
          <div class="stat-label">At Risk Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avg-gpa">0.00</div>
          <div class="stat-label">Average GPA</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="active-enrollments">0</div>
          <div class="stat-label">Active Enrollments</div>
        </div>
    </div>

    <div class="grid">
        <div class="card">
          <h2><span class="card-icon">ðŸ‘¥</span>My Students</h2>
          <div class="list" id="student-list">
            <!-- Students will be loaded here -->
          </div>
        </div>
        <div class="card">
          <h2><span class="card-icon">ðŸ””</span>Recent Activity</h2>
          <div class="list" id="activity-list">
            <!-- Activity will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Students Tab -->
    <div id="students" class="tab-content">
      <div class="card">
        <h2><span class="card-icon">ðŸ‘¥</span>Students</h2>
        
        <!-- Advanced Filters -->
        <div class="filters-section" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Sort by:</label>
              <select id="sort-by" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="firstName">Name</option>
                <option value="studentId">Student ID</option>
                <option value="major">Department</option>
                <option value="year">Year</option>
                <option value="enrollmentStatus">Enrollment Status</option>
                <option value="gpa">GPA</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Order:</label>
              <select id="sort-order" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Department:</label>
              <select id="department-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Departments</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Engineering">Engineering</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Year:</label>
              <select id="year-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Years</option>
                <option value="First Year">First Year</option>
                <option value="Second Year">Second Year</option>
                <option value="Third Year">Third Year</option>
                <option value="Fourth Year">Fourth Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Status:</label>
              <select id="status-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Status</option>
                <option value="Enrolled">Enrolled</option>
                <option value="Graduated">Graduated</option>
                <option value="Suspended">Suspended</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Risk Level:</label>
              <select id="risk-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Risk Levels</option>
                <option value="low">Low Risk</option>
                <option value="medium">Medium Risk</option>
                <option value="high">High Risk</option>
              </select>
            </div>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button id="apply-filters" class="btn primary" style="padding: 8px 16px;">Apply Filters</button>
            <button id="clear-filters" class="btn secondary" style="padding: 8px 16px;">Clear All</button>
            <span id="filter-results" style="color: #6b7280; font-size: 14px;"></span>
          </div>
        </div>

        <div class="list" id="student-list-detailed">
          <!-- Detailed student list will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Courses Tab -->
    <div id="courses" class="tab-content">
      <div class="card">
        <h2><span class="card-icon">ðŸ“š</span>Course Management</h2>
        <div class="actions">
          <button class="btn primary" onclick="openCourseModal()">Add Course</button>
        </div>
        <div class="list" id="course-list">
          <!-- Courses will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <div id="analytics" class="tab-content">
      <div class="grid-3">
        <div class="card">
          <h2><span class="card-icon">ðŸ“Š</span>Retention Rates</h2>
          <p>Track student retention by semester and program.</p>
          <div style="height:220px"><canvas id="retentionChart"></canvas></div>
          <div style="margin-top:8px"><button class="btn primary" onclick="openReportModal()">Generate Report</button></div>
        </div>
        <div class="card">
          <h2><span class="card-icon">ðŸ“ˆ</span>Performance Trends</h2>
          <p>GPA distribution across bands.</p>
          <div style="height:220px"><canvas id="performanceChart"></canvas></div>
        </div>
        <div class="card">
          <h2><span class="card-icon">ðŸŽ¯</span>Risk Analysis</h2>
          <p>At-risk students by major.</p>
          <div style="height:220px"><canvas id="riskChart"></canvas></div>
        </div>
      </div>
    </div>

  </div>

  <!-- Student Detail Modal -->
  <div id="student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Student Details</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="form">
        <div class="form-row">
          <div>
            <label>Name:</label>
            <input type="text" id="modal-student-name" readonly>
          </div>
          <div>
            <label>Student ID:</label>
            <input type="text" id="modal-student-id" readonly>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Major:</label>
            <input type="text" id="modal-student-major" readonly>
          </div>
          <div>
            <label>GPA:</label>
            <input type="text" id="modal-student-gpa" readonly>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Year:</label>
            <input type="text" id="modal-student-year" readonly>
          </div>
          <div>
            <label>Status:</label>
            <input type="text" id="modal-student-status" readonly>
          </div>
        </div>
        <div>
          <label>Notes:</label>
          <textarea placeholder="Add notes about this student..."></textarea>
        </div>
        <div class="actions">
          <button class="btn secondary" onclick="document.getElementById('student-modal').classList.remove('active')">Close</button>
          <button class="btn primary">Save Notes</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Student Modal -->
  <div id="add-student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Student</h2>
        <button class="modal-close">&times;</button>
      </div>
      <form id="add-student-form" class="form">
        <div class="form-row">
          <div>
            <label>First Name:</label>
            <input type="text" name="firstName" required>
          </div>
          <div>
            <label>Last Name:</label>
            <input type="text" name="lastName" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Student ID:</label>
            <input type="number" name="studentId" required>
          </div>
          <div>
            <label>Email:</label>
            <input type="email" name="email" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Major:</label>
            <select name="major" required>
              <option value="Computer Science">Computer Science</option>
              <option value="Engineering">Engineering</option>
              <option value="Business">Business</option>
              <option value="Mathematics">Mathematics</option>
            </select>
          </div>
          <div>
            <label>Year:</label>
            <select name="year" required>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
              <option value="2026">2026</option>
              <option value="2027">2027</option>
            </select>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="btn secondary" onclick="document.getElementById('add-student-modal').classList.remove('active')">Cancel</button>
          <button type="button" class="btn primary" onclick="addStudent()">Add Student</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Course Modal -->
  <div id="course-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Course</h2>
        <button class="modal-close">&times;</button>
      </div>
      <form id="add-course-form" class="form">
        <div class="form-row">
          <div>
            <label>Course Code:</label>
            <input type="text" name="courseCode" required>
          </div>
          <div>
            <label>Course Name:</label>
            <input type="text" name="courseName" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Department:</label>
            <select name="department" required>
              <option value="CS">Computer Science</option>
              <option value="ENG">Engineering</option>
              <option value="BUS">Business</option>
              <option value="MATH">Mathematics</option>
            </select>
          </div>
          <div>
            <label>Credits:</label>
            <input type="number" name="credits" min="1" max="6" required>
          </div>
        </div>
        <div>
          <label>Description:</label>
          <textarea name="description" placeholder="Course description..."></textarea>
        </div>
        <div class="actions">
          <button type="button" class="btn secondary" onclick="document.getElementById('course-modal').classList.remove('active')">Cancel</button>
          <button type="button" class="btn primary" onclick="addCourse()">Add Course</button>
        </div>
          </form>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="report-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Generate Report</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="form">
        <div>
          <label>Report Type:</label>
          <select id="report-type">
            <option value="retention">Retention Report</option>
            <option value="performance">Performance Report</option>
            <option value="risk">Risk Analysis Report</option>
            <option value="enrollment">Enrollment Report</option>
          </select>
        </div>
        <div class="form-row">
          <div>
            <label>Start Date:</label>
            <input type="date" id="start-date" required>
          </div>
          <div>
            <label>End Date:</label>
            <input type="date" id="end-date" required>
          </div>
        </div>
        <div class="actions">
          <button class="btn secondary" onclick="document.getElementById('report-modal').classList.remove('active')">Cancel</button>
          <button class="btn primary" onclick="generateReport()">Generate Report</button>
        </div>
        <div id="report-results" style="margin-top:12px;color:#374151;"></div>
      </div>
    </div>
  </div>

  <!-- At Risk Students Modal -->
  <div id="at-risk-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>At Risk Students (GPA < 3.1)</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div id="at-risk-list" class="list">
        <div class="loading">Loading at-risk students...</div>
      </div>
    </div>
  </div>
</body>
</html>


