<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Advisor Dashboard - Student Retention System</title>
  <link rel="stylesheet" href="../src/styles/variables.css" />
  <link rel="stylesheet" href="../src/styles/cursor.css" />
  <link rel="stylesheet" href="../src/styles/interactions.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { 
      font-family: system-ui,-apple-system,Segoe UI,Roboto,sans-serif; 
      background: linear-gradient(135deg, rgba(107,114,128,.1) 0%, rgba(156,163,175,.1) 100%), url('../Images/advisors-advising-students.png') center / cover no-repeat fixed; 
      min-height: 100vh; 
      color: #1f2937; 
    }
    .dashboard { 
      background: rgba(255,255,255,.95); 
      backdrop-filter: blur(10px); 
      border-radius: 20px; 
      padding: 28px; 
      box-shadow: 0 20px 40px rgba(0,0,0,.12); 
      width: 100%; 
      max-width: 1400px; 
      margin: 24px auto;
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 30px; 
      padding-bottom: 20px;
      border-bottom: 2px solid #e5e7eb;
    }
    .title { display: flex; gap: 12px; align-items: center; }
    .avatar { 
      width: 50px; 
      height: 50px; 
      border-radius: 50%; 
      background: linear-gradient(135deg,#6b7280,#9ca3af); 
      color: #fff; 
      display: grid; 
      place-items: center; 
      font-weight: 700; 
      box-shadow: 0 6px 16px rgba(107,114,128,.35); 
    }
    .header h1 { font-size: 24px; color: #1f2937; }
    .header .meta { color: #6b7280; font-size: 14px; margin-top: 2px; }
    .header-actions {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .notification-bell {
      position: relative;
      background: rgba(107,114,128,.08);
      border: none;
      border-radius: 10px;
      padding: 12px 16px;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s ease;
    }
    .notification-bell:hover {
      background: rgba(107,114,128,.15);
    }
    .notification-badge {
      position: absolute;
      top: 8px;
      right: 8px;
      background: #dc2626;
      color: white;
      border-radius: 50%;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }
    .signout { 
      color: #6b7280; 
      text-decoration: none; 
      font-weight: 700; 
      padding: 12px 16px; 
      border-radius: 10px; 
      background: rgba(107,114,128,.08); 
      transition: all 0.3s ease;
    }
    .signout:hover { background: rgba(107,114,128,.15); }
    
    .notification-item {
      padding: 16px;
      border-bottom: 1px solid #e5e7eb;
      cursor: pointer;
      transition: background 0.2s ease;
    }
    .notification-item:hover {
      background: #f9fafb;
    }
    .notification-item.unread {
      background: #eff6ff;
      border-left: 4px solid #0d47a1;
    }
    .notification-item.unread:hover {
      background: #dbeafe;
    }
    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 8px;
    }
    .notification-title {
      font-weight: 600;
      color: #1f2937;
      font-size: 15px;
    }
    .notification-time {
      font-size: 12px;
      color: #6b7280;
    }
    .notification-message {
      color: #4b5563;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 8px;
    }
    .notification-details {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .notification-chip {
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }
    .notification-chip.urgency-high {
      background: #fee2e2;
      color: #991b1b;
    }
    .notification-chip.urgency-normal {
      background: #fef3c7;
      color: #92400e;
    }
    .notification-chip.urgency-low {
      background: #d1fae5;
      color: #166534;
    }
    .notification-chip.category {
      background: #e0e7ff;
      color: #3730a3;
    }
    
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e5e7eb;
    }
    .nav-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.3s ease;
    }
    .nav-tab.active {
      background: #6b7280;
      color: white;
    }
    .nav-tab:hover:not(.active) {
      background: rgba(107,114,128,.1);
    }
    
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
    
    .grid { 
      display: grid; 
      grid-template-columns: 2fr 1fr; 
      gap: 24px; 
    }
    .grid-3 { 
      display: grid; 
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
      gap: 20px; 
    }
    .card { 
      background: #fff; 
      border: 1px solid #e5e7eb; 
      border-radius: 16px; 
      padding: 24px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.06); 
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,.1);
    }
    .card h2 { 
      font-size: 20px; 
      margin-bottom: 16px; 
      color: #1f2937; 
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-icon {
      width: 24px;
      height: 24px;
      background: #6b7280;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
    }
    
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .stat-card {
      background: linear-gradient(135deg, #6b7280, #9ca3af);
      color: white;
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-card.clickable {
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .stat-card.clickable:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .stat-number {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 4px;
    }
    .stat-label {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .list { display: grid; gap: 12px; }
    #student-list {
      max-height: 500px;
      overflow-y: auto;
      overflow-x: hidden;
      padding-right: 8px;
    }
    #student-list::-webkit-scrollbar {
      width: 8px;
    }
    #student-list::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 10px;
    }
    #student-list::-webkit-scrollbar-thumb {
      background: #6b7280;
      border-radius: 10px;
    }
    #student-list::-webkit-scrollbar-thumb:hover {
      background: #4b5563;
    }
    .list-item { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 16px; 
      border: 1px solid #e5e7eb; 
      border-radius: 12px; 
      background: #f9fafb; 
      transition: all 0.3s ease;
    }
    .list-item:hover {
      background: #f3f4f6;
      border-color: #6b7280;
    }
    .student-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .student-name {
      font-weight: 600;
      color: #1f2937;
    }
    .student-details {
      font-size: 14px;
      color: #6b7280;
    }
    .chip { 
      padding: 6px 12px; 
      border-radius: 999px; 
      font-size: 12px; 
      font-weight: 600;
    }
    .chip.success { background: #dcfce7; color: #166534; }
    .chip.warning { background: #fef3c7; color: #92400e; }
    .chip.danger { background: #fee2e2; color: #991b1b; }
    .chip.info { background: #dbeafe; color: #1e40af; }
    
    .form { display: grid; gap: 16px; }
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    input, select, textarea { 
      width: 100%; 
      padding: 12px 16px; 
      border: 2px solid #e5e7eb; 
      border-radius: 12px; 
      background: #fff; 
      font-size: 14px; 
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #6b7280;
    }
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    .actions { 
      display: flex; 
      justify-content: flex-end; 
      gap: 12px; 
      margin-top: 20px;
    }
    .btn { 
      border: 0; 
      border-radius: 12px; 
      padding: 12px 20px; 
      font-weight: 600; 
      cursor: pointer; 
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .btn.primary { 
      background: linear-gradient(135deg,#6b7280,#9ca3af); 
      color: #fff; 
      box-shadow: 0 8px 20px rgba(107,114,128,.3); 
    }
    .btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 28px rgba(107,114,128,.4);
    }
    .btn.secondary {
      background: #f3f4f6;
      color: #6b7280;
      border: 2px solid #e5e7eb;
    }
    .btn.secondary:hover {
      background: #e5e7eb;
    }
    .btn.danger {
      background: #fee2e2;
      color: #991b1b;
      border: 2px solid #fecaca;
    }
    .btn.danger:hover {
      background: #fecaca;
    }
    
    .search-bar {
      display: flex;
      gap: 12px;
      margin-bottom: 20px;
    }
    .search-bar input {
      flex: 1;
    }
    .search-bar select {
      width: 200px;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }
    .modal.active {
      display: flex;
    }
    .modal-content {
      background: white;
      border-radius: 16px;
      padding: 32px;
      max-width: 600px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #6b7280;
    }
    
    @media (max-width: 900px){ 
      .grid { grid-template-columns: 1fr; } 
      .form-row { grid-template-columns: 1fr; }
      .nav-tabs { flex-wrap: wrap; }
      .search-bar { flex-direction: column; }
      .search-bar select { width: 100%; }
    }
  </style>
  <link rel="stylesheet" href="styles/theme.css" />
  <script type="module" src="../src/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    let currentAdvisor = null;
    let students = [];
    let courses = [];
    let enrollments = [];
    let myStudentsData = []; // Store original student data for filtering
    
    // API Configuration
    const API_BASE_URL = window.location.origin;

    // Authentication check - must be first
    (function() {
      const advisorId = localStorage.getItem('advisorId');
      const advisorSessionToken = localStorage.getItem('advisorSessionToken');
      
      // If no authentication, redirect to login
      if (!advisorId || !advisorSessionToken) {
        // Clear any remaining data
        localStorage.clear();
        sessionStorage.clear();
        // Redirect to login
        window.location.href = 'index.html';
        return;
      }
    })();

    // Prevent back button access after logout
    window.addEventListener('pageshow', function(event) {
      // If page was loaded from cache (back button), check authentication
      if (event.persisted) {
        const advisorId = localStorage.getItem('advisorId');
        const advisorSessionToken = localStorage.getItem('advisorSessionToken');
        
        if (!advisorId || !advisorSessionToken) {
          localStorage.clear();
          sessionStorage.clear();
          window.location.href = 'index.html';
        }
      }
    });

    document.addEventListener('DOMContentLoaded', async () => {
      // Double-check authentication on load
      const advisorId = localStorage.getItem('advisorId');
      const advisorSessionToken = localStorage.getItem('advisorSessionToken');
      
      if (!advisorId || !advisorSessionToken) {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = 'index.html';
        return;
      }
      
      console.log('DOM Content Loaded - Initializing dashboard...');
      
      try {
        // Load student statuses from localStorage
        loadStudentStatuses();
        
        await loadAdvisorData();
        console.log('Advisor data loaded');
        
        // await loadStudents();
        // console.log('Students loaded:', students.length);
        
        await loadCourses();
        console.log('Courses loaded:', courses.length);
        
        await loadEnrollments();
        console.log('Enrollments loaded:', enrollments.length);
        
        await updateDashboard();
        console.log('Dashboard updated');
        
        setupEventListeners();
        console.log('Event listeners set up');
        
        console.log('Dashboard initialization complete');
      } catch (error) {
        console.error('Error initializing dashboard:', error);
      }
    });

    async function loadAdvisorData() {
      const advisorId = localStorage.getItem('advisorId');
      if (advisorId) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/data/advisors/${advisorId}`);
          if (response.ok) {
            currentAdvisor = await response.json();
            updateHeader();
            // Load profile if profile tab is active
            if (document.getElementById('profile')?.classList.contains('active')) {
              await loadAdvisorProfile(advisorId);
            }
          }
        } catch (error) {
          console.error('Error loading advisor data:', error);
        }
      }
    }

    async function loadAdvisorProfile(advisorId) {
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/advisors/${advisorId}`);
        if (!response.ok) {
          throw new Error('Failed to load profile');
        }
        const advisor = await response.json();
        
        // Display profile information
        const advisorFullName = `${advisor.firstName} ${advisor.lastName}`;
        document.getElementById('advisor-profile-name').textContent = advisorFullName;
        document.getElementById('advisor-profile-email').textContent = advisor.email || 'Not provided';
        document.getElementById('advisor-profile-phone').textContent = advisor.phone || 'Not provided';
        document.getElementById('advisor-profile-department').textContent = advisor.department || 'Not provided';
        document.getElementById('advisor-profile-specialization').textContent = advisor.specialization || 'Not provided';
        document.getElementById('advisor-profile-title').textContent = advisor.title || 'Not provided';
        document.getElementById('advisor-profile-office').textContent = advisor.officeLocation || 'Not provided';
        document.getElementById('advisor-profile-hours').textContent = advisor.officeHours || 'Not provided';
        
        // Store advisor name for Google Form responses
        window.currentAdvisorName = advisorFullName;
        
        // Load Google Form responses if requests tab is active
        if (document.getElementById('notifications')?.classList.contains('active')) {
          await loadGoogleFormResponses();
        }
        
        // Format address
        const addr = advisor.address || {};
        const addressParts = [];
        if (addr.street) addressParts.push(addr.street);
        if (addr.city) addressParts.push(addr.city);
        if (addr.state) addressParts.push(addr.state);
        if (addr.zipCode) addressParts.push(addr.zipCode);
        if (addr.country) addressParts.push(addr.country);
        document.getElementById('advisor-profile-address').textContent = addressParts.length > 0 ? addressParts.join(', ') : 'Not provided';
        
        // Populate edit form
        document.getElementById('edit-advisor-name').value = `${advisor.firstName} ${advisor.lastName}`;
        document.getElementById('edit-advisor-email').value = advisor.email || '';
        document.getElementById('edit-advisor-phone').value = advisor.phone || '';
        document.getElementById('edit-advisor-department').value = advisor.department || '';
        document.getElementById('edit-advisor-specialization').value = advisor.specialization || '';
        document.getElementById('edit-advisor-title').value = advisor.title || '';
        document.getElementById('edit-advisor-office').value = advisor.officeLocation || '';
        document.getElementById('edit-advisor-hours').value = advisor.officeHours || '';
        document.getElementById('edit-advisor-address-street').value = addr.street || '';
        document.getElementById('edit-advisor-address-city').value = addr.city || '';
        document.getElementById('edit-advisor-address-state').value = addr.state || '';
        document.getElementById('edit-advisor-address-zip').value = addr.zipCode || '';
        document.getElementById('edit-advisor-address-country').value = addr.country || 'USA';
      } catch (error) {
        console.error('Error loading advisor profile:', error);
        document.getElementById('advisor-profile-name').textContent = 'Error loading profile';
      }
    }

    function toggleAdvisorProfileEdit() {
      const display = document.getElementById('advisor-profile-display');
      const edit = document.getElementById('advisor-profile-edit');
      const btn = document.getElementById('edit-advisor-profile-btn');
      
      if (edit.style.display === 'none') {
        display.style.display = 'none';
        edit.style.display = 'block';
        btn.textContent = 'View Profile';
      } else {
        display.style.display = 'block';
        edit.style.display = 'none';
        btn.textContent = 'Edit Profile';
        // Reload profile to reset form
        const advisorId = localStorage.getItem('advisorId');
        if (advisorId) loadAdvisorProfile(advisorId);
      }
    }

    async function saveAdvisorProfile(event) {
      event.preventDefault();
      const advisorId = localStorage.getItem('advisorId');
      if (!advisorId) {
        alert('Advisor ID not found. Please log in again.');
        return;
      }

      try {
        const formData = {
          phone: document.getElementById('edit-advisor-phone').value,
          department: document.getElementById('edit-advisor-department').value,
          specialization: document.getElementById('edit-advisor-specialization').value,
          title: document.getElementById('edit-advisor-title').value,
          officeLocation: document.getElementById('edit-advisor-office').value,
          officeHours: document.getElementById('edit-advisor-hours').value,
          address: {
            street: document.getElementById('edit-advisor-address-street').value,
            city: document.getElementById('edit-advisor-address-city').value,
            state: document.getElementById('edit-advisor-address-state').value,
            zipCode: document.getElementById('edit-advisor-address-zip').value,
            country: document.getElementById('edit-advisor-address-country').value
          }
        };

        const response = await fetch(`${API_BASE_URL}/api/auth/advisor/profile/${advisorId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to update profile');
        }

        alert('Profile updated successfully!');
        toggleAdvisorProfileEdit();
        await loadAdvisorProfile(advisorId);
        // Reload advisor data to update header
        await loadAdvisorData();
      } catch (error) {
        console.error('Error saving advisor profile:', error);
        alert('Failed to update profile. Please try again. Error: ' + error.message);
      }
    }



    async function loadGoogleFormResponses(advisorName = null) {
      const responsesList = document.getElementById('google-form-responses-list');
      if (!responsesList) {
        return;
      }

      try {
        responsesList.innerHTML = '<div class="loading">Loading help request responses...</div>';
        
        // Fetch all responses (don't filter by advisor name)
        const url = advisorName 
          ? `${API_BASE_URL}/api/google-forms/responses?advisorName=${encodeURIComponent(advisorName)}`
          : `${API_BASE_URL}/api/google-forms/responses`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          // Try to get error details from response
          let errorMessage = `Failed to load responses: ${response.status}`;
          try {
            const errorData = await response.json();
            errorMessage = errorData.details || errorData.error || errorMessage;
          } catch (e) {
            // If response is not JSON, use status text
            errorMessage = `${errorMessage} - ${response.statusText}`;
          }
          throw new Error(errorMessage);
        }

        const data = await response.json();
        const responses = data.responses || [];

        if (responses.length === 0) {
          responsesList.innerHTML = '<div class="list-item" style="text-align: center; color: #6b7280; padding: 20px;">No help request responses found.</div>';
          return;
        }

        // Display responses with advisor information
        responsesList.innerHTML = responses.map((resp, index) => {
          const timestamp = resp['Timestamp'] || resp['timestamp'] || '';
          const studentName = resp['Name'] || resp['name'] || 'Unknown';
          const studentEmail = resp['Email'] || resp['Email address'] || resp['email'] || '';
          const phone = resp['Phone number'] || resp['phone'] || 'Not provided';
          const category = resp['Category'] || resp['category'] || 'General';
          const message = resp['Message'] || resp['message'] || '';
          const otherDetails = resp['If Other please mention here'] || resp['Other'] || '';
          const advisor = resp['Advisor'] || resp['advisor'] || 'Not assigned';
          
          // Format timestamp
          let formattedDate = timestamp;
          if (timestamp) {
            try {
              const date = new Date(timestamp);
              formattedDate = date.toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
              });
            } catch (e) {
              // Keep original timestamp if parsing fails
            }
          }

          return `
            <div class="list-item" style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px; background: #fff;">
              <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                <div style="flex: 1;">
                  <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; font-size: 16px;">${escapeHtml(studentName)}</div>
                  <div style="font-size: 12px; color: #6b7280;">${formattedDate}</div>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                  <span class="chip info" style="background: #dbeafe; color: #1e40af;">${escapeHtml(category)}</span>
                  ${advisor && advisor !== 'Not assigned' ? `<span class="chip" style="background: #fef3c7; color: #92400e; font-size: 11px;">ðŸ‘¤ ${escapeHtml(advisor)}</span>` : ''}
                </div>
              </div>
              
              <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
                <div style="margin-bottom: 8px;">
                  <strong style="color: #374151; font-size: 13px;">Email:</strong>
                  <span style="color: #6b7280; font-size: 13px; margin-left: 8px;">${escapeHtml(studentEmail)}</span>
                </div>
                <div style="margin-bottom: 8px;">
                  <strong style="color: #374151; font-size: 13px;">Phone:</strong>
                  <span style="color: #6b7280; font-size: 13px; margin-left: 8px;">${escapeHtml(phone)}</span>
                </div>
                ${advisor && advisor !== 'Not assigned' ? `
                <div style="margin-bottom: 8px;">
                  <strong style="color: #374151; font-size: 13px;">Assigned Advisor:</strong>
                  <span style="color: #6b7280; font-size: 13px; margin-left: 8px;">${escapeHtml(advisor)}</span>
                </div>
                ` : ''}
                ${message ? `
                <div style="margin-bottom: 8px;">
                  <strong style="color: #374151; font-size: 13px;">Message:</strong>
                  <div style="color: #1f2937; font-size: 13px; margin-top: 4px; padding: 8px; background: #f9fafb; border-radius: 6px; white-space: pre-wrap;">${escapeHtml(message)}</div>
                </div>
                ` : ''}
                ${otherDetails ? `
                <div style="margin-bottom: 8px;">
                  <strong style="color: #374151; font-size: 13px;">Additional Details:</strong>
                  <div style="color: #1f2937; font-size: 13px; margin-top: 4px; padding: 8px; background: #f9fafb; border-radius: 6px; white-space: pre-wrap;">${escapeHtml(otherDetails)}</div>
                </div>
                ` : ''}
              </div>
            </div>
          `;
        }).join('');
        
        // Add summary at the top
        const summary = document.createElement('div');
        summary.style.cssText = 'margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px; font-size: 13px; color: #374151;';
        summary.innerHTML = `<strong>Total Responses:</strong> ${data.total || responses.length}${data.totalAll && data.totalAll !== data.total ? ` (${data.totalAll} total in sheet)` : ''}`;
        responsesList.insertBefore(summary, responsesList.firstChild);

      } catch (error) {
        console.error('Error loading Google Form responses:', error);
        // Show a simple message and suggest using the direct link
        responsesList.innerHTML = `
          <div class="list-item" style="text-align: center; color: #6b7280; padding: 20px;">
            <div style="margin-bottom: 12px; font-size: 14px;">Unable to load responses automatically.</div>
            <div style="font-size: 13px; color: #9ca3af;">Please use the "Open Google Sheets" button above to view responses directly.</div>
          </div>
        `;
      }
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'just now';
      const minutes = Math.floor(seconds / 60);
      if (minutes < 60) return `${minutes}m ago`;
      const hours = Math.floor(minutes / 60);
      if (hours < 24) return `${hours}h ago`;
      const days = Math.floor(hours / 24);
      if (days < 7) return `${days}d ago`;
      const weeks = Math.floor(days / 7);
      return `${weeks}w ago`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    async function loadStudents() {
      /*
      try {
        // Fetch students from CSV files
        const response = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (response.ok) {
          const data = await response.json();
          students = Array.isArray(data) ? data : [];
          console.log('Students data from CSV:', students.length, 'students loaded');
        } else {
          console.error('Failed to load students:', response.status);
          students = [];
        }
      } catch (error) {
        console.error('Error loading students:', error);
        students = [];
      }
      */
    }

    async function loadFilteredStudents() {
      /*
      try {
        const sortBy = document.getElementById('sort-by').value;
        const sortOrder = document.getElementById('sort-order').value;
        const department = document.getElementById('department-filter').value;
        const year = document.getElementById('year-filter').value;
        const enrollmentStatus = document.getElementById('status-filter').value;
        const search = document.getElementById('student-search').value;

        const params = new URLSearchParams({
          sortBy,
          sortOrder,
          ...(department && { department }),
          ...(year && { year }),
          ...(enrollmentStatus && { enrollmentStatus }),
          ...(search && { search })
        });

        const response = await fetch(`${API_BASE_URL}/api/data/students/detailed?${params}&limit=2000`);
        if (response.ok) {
          const data = await response.json();
          students = Array.isArray(data) ? data : [];
          console.log('Filtered students:', students.length, 'students loaded');
          updateStudentList();
          updateFilterResults();
        } else {
          console.error('Failed to load filtered students:', response.status);
        }
      } catch (error) {
        console.error('Error loading filtered students:', error);
      }
      */
    }

    function updateFilterResults() {
      /*
      const resultsSpan = document.getElementById('filter-results');
      if (resultsSpan) {
        resultsSpan.textContent = `Showing ${students.length} students`;
      }
      */
    }

    async function loadCourses() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/courses`);
        if (response.ok) {
          const data = await response.json();
          courses = Array.isArray(data) ? data : [];
          console.log('Courses data:', courses.length, 'courses loaded');
          // Refresh UI after loading courses from CSV
          updateCourseList();
        } else {
          console.error('Failed to load courses:', response.status);
          courses = [];
        }
      } catch (error) {
        console.error('Error loading courses:', error);
        courses = [];
      }
    }

    async function loadEnrollments() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/enrollments`);
        if (response.ok) {
          const data = await response.json();
          enrollments = Array.isArray(data) ? data : [];
          console.log('Enrollments data:', enrollments.length, 'enrollments loaded');
        } else {
          console.error('Failed to load enrollments:', response.status);
          enrollments = [];
        }
      } catch (error) {
        console.error('Error loading enrollments:', error);
        enrollments = [];
      }
    }

    function updateHeader() {
      if (currentAdvisor) {
        // Clean up firstName and lastName to remove "Not provided"
        let firstName = (currentAdvisor.firstName || '').replace(/Not provided/gi, '').trim();
        let lastName = (currentAdvisor.lastName || '').replace(/Not provided/gi, '').trim();
        
        // Remove extra spaces
        firstName = firstName.replace(/\s+/g, ' ');
        lastName = lastName.replace(/\s+/g, ' ');
        
        // Use cleaned names for initials
        const firstInitial = firstName && firstName[0] ? firstName[0].toUpperCase() : 'A';
        const lastInitial = lastName && lastName[0] ? lastName[0].toUpperCase() : 'A';
        const initials = `${firstInitial}${lastInitial}`;
        
        // Build display name
        let displayName = '';
        if (firstName && lastName) {
          displayName = `${firstName} ${lastName}`;
        } else if (firstName) {
          displayName = firstName;
        } else if (lastName) {
          displayName = lastName;
        } else {
          displayName = 'Advisor';
        }
        
        document.getElementById('welcome').textContent = `Welcome, ${displayName}`;
        document.getElementById('advisor-id-line').textContent = `ID: ${currentAdvisor.advisorId} â€¢ ${currentAdvisor.department}`;
        document.getElementById('avatar').textContent = initials;
      }
    }

    async function updateDashboard() {
      // Ensure advisor data is loaded first
      if (!currentAdvisor) {
        await loadAdvisorData();
      }
      
      await updateStats();
      await loadAndDisplayStudents();
      updateCourseList();
      // Render charts if analytics tab already visible
      maybeRenderAnalyticsCharts();
      // Load Students Status s if tab is active
      if (document.getElementById('status-students')?.classList.contains('active')) {
        await loadStatusStudents();
      }
    }
    
    function updateCourseList() {
      // Ensure courses is an array
      if (!Array.isArray(courses)) {
        console.warn('Courses data is not an array:', courses);
        courses = [];
      }
      
      const courseList = document.getElementById('course-list');
      if (!courseList) return;
      
      courseList.innerHTML = '';
      
      courses.forEach(course => {
        const courseItem = document.createElement('div');
        courseItem.className = 'list-item';
        courseItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${course.course_title || course.courseName || 'No title'}</div>
            <div class="student-details">${course.course_code || course.courseCode || 'No code'} â€¢ ${course.department || 'No department'} â€¢ ${course.credits || 'No credits'} credits</div>
            ${course.description ? `<div class="course-description">${course.description}</div>` : ''}
          </div>
          <span class="chip success">Active</span>
        `;
        courseList.appendChild(courseItem);
      });
    }

    async function updateStats() {
      try {
        // Fetch statistics from CSV-based endpoint
        const response = await fetch(`${API_BASE_URL}/api/data/csv-stats`);
        if (response.ok) {
          const stats = await response.json();
          
          console.log('CSV Stats loaded:', stats);

          document.getElementById('total-students').textContent = stats.totalStudents;
          document.getElementById('at-risk-students').textContent = stats.atRiskStudents;
          document.getElementById('avg-gpa').textContent = stats.averageGPA.toFixed(2);
          document.getElementById('active-enrollments').textContent = stats.activeEnrollments;
          const rrEl = document.getElementById('retention-rate');
          if (rrEl) rrEl.textContent = `${stats.retentionRate}%`;
        } else {
          console.error('Failed to load CSV stats:', response.status);
          // Fallback to 0 values
          document.getElementById('total-students').textContent = '0';
          document.getElementById('at-risk-students').textContent = '0';
          document.getElementById('avg-gpa').textContent = '0.00';
          document.getElementById('active-enrollments').textContent = '0';
          const rrEl = document.getElementById('retention-rate');
          if (rrEl) rrEl.textContent = '0%';
        }
      } catch (error) {
        console.error('Error loading CSV stats:', error);
        // Fallback to 0 values
        document.getElementById('total-students').textContent = '0';
        document.getElementById('at-risk-students').textContent = '0';
        document.getElementById('avg-gpa').textContent = '0.00';
        document.getElementById('active-enrollments').textContent = '0';
        const rrEl = document.getElementById('retention-rate');
        if (rrEl) rrEl.textContent = '0%';
      }
    }

    // Function to calculate risk level based on GPA
    function calculateRiskLevel(gpa) {
      // Ensure GPA is a number
      const numGpa = parseFloat(gpa);
      if (isNaN(numGpa) || numGpa < 0) {
        // Default for invalid GPA
        return { level: 'info', text: 'Unknown' };
      }
      
      if (numGpa >= 0 && numGpa <= 2.99) {
        return { level: 'danger', text: 'High Risk' };
      } else if (numGpa >= 3.00 && numGpa <= 3.20) {
        return { level: 'warning', text: 'Medium Risk' };
      } else if (numGpa > 3.20) {
        return { level: 'success', text: 'No Risk' };
      } else {
        // Default for invalid GPA
        return { level: 'info', text: 'Unknown' };
      }
    }

    async function loadAndDisplayStudents() {
      try {
        // Get the advisor's advisorId to filter students for "My Students" card only
        const advisorId = currentAdvisor?.advisorId;
        let url = `${API_BASE_URL}/api/data/csv-students`;
        
        // Add advisor_id filter if available (only for the student list, not for stats)
        if (advisorId) {
          url += `?advisor_id=${advisorId}`;
        }
        
        const response = await fetch(url);
        if (response.ok) {
          const studentData = await response.json();
          // Store original data for filtering
          myStudentsData = studentData;
          // Populate major filter
          populateMyStudentsMajorFilter(studentData);
          // Apply any existing filters
          applyMyStudentsFilters();
          // Note: Stats are updated separately in updateStats() to show ALL students
        } else {
          console.error('Failed to load students:', response.status);
        }
      } catch (error) {
        console.error('Error loading students:', error);
      }
    }

    function updateStudentList(studentData) {
      // Ensure studentData is an array
      if (!Array.isArray(studentData)) {
        console.warn('Student data is not an array:', studentData);
        studentData = [];
      }
      
      const studentList = document.getElementById('student-list');
      if (!studentList) return;
      
      studentList.innerHTML = '';

      studentData.forEach(student => {
        // Calculate risk level based on GPA
        let gpa = student.academic?.gpa;
        // Ensure GPA is a valid number
        if (gpa === null || gpa === undefined || isNaN(gpa)) {
          gpa = 0;
        } else {
          gpa = parseFloat(gpa);
          if (isNaN(gpa)) {
            gpa = 0;
          }
        }
        const risk = calculateRiskLevel(gpa);
        const absences = student.academic?.attendanceAbsences || 0;
        const credits = Math.min(student.academic?.creditsEarned || 0, 33); // Cap at 33
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${student.firstName || student.first_name} ${student.lastName || student.last_name}</div>
            <div class="student-details">
              ID: ${student.studentId || student.student_id} â€¢ ${student.major || 'N/A'} â€¢ ${student.year || 'N/A'} â€¢ 
              GPA: ${gpa.toFixed(2)} â€¢ Credits: ${credits} â€¢ Absences: ${absences}
            </div>
            ${student.email ? `<div class="student-contact">ðŸ“§ ${student.email}${student.phone ? ` â€¢ ðŸ“ž ${student.phone}` : ''}</div>` : ''}
          </div>
          <span class="chip ${risk.level}">${risk.text}</span>
        `;
        
        if (studentList) {
          studentList.appendChild(studentItem);
        }
      });
    }


    // Tab switching function (can be called from onclick handlers)
    async function switchTab(tabId) {
      // Remove active class from all tabs and content
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Add active class to selected tab and corresponding content
      const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
      if (tabButton) {
        tabButton.classList.add('active');
      }
      
      const targetContent = document.getElementById(tabId);
      if (targetContent) {
        targetContent.classList.add('active');
        console.log('Switched to tab:', tabId);
        
        // If switching to requests tab, load Google Form responses
        if (tabId === 'notifications') {
          await loadGoogleFormResponses();
        }
        // If switching to profile tab, load profile
        if (tabId === 'profile') {
          const advisorId = localStorage.getItem('advisorId');
          if (advisorId) {
            await loadAdvisorProfile(advisorId);
          }
        }
      } else {
        console.error('Target content not found:', tabId);
      }
    }

    function setupEventListeners() {
      console.log('Setting up event listeners...');
      
      // Tab switching
      const navTabs = document.querySelectorAll('.nav-tab');
      console.log('Found nav tabs:', navTabs.length);
      
      navTabs.forEach(tab => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          console.log('Tab clicked:', tab.dataset.tab);
          switchTab(tab.dataset.tab);
        });
      });


      // Legacy search functionality (keeping for backward compatibility)
      /*
      const studentSearch = document.getElementById('student-search');
      if (studentSearch) {
        studentSearch.addEventListener('input', (e) => {
          // Use the new filtered API instead of client-side filtering
          loadFilteredStudents();
        });
      }

      // Filter controls
      const applyFiltersBtn = document.getElementById('apply-filters');
      if (applyFiltersBtn) {
        applyFiltersBtn.addEventListener('click', () => {
          loadFilteredStudents();
        });
      }

      const clearFiltersBtn = document.getElementById('clear-filters');
      if (clearFiltersBtn) {
        clearFiltersBtn.addEventListener('click', () => {
          // Reset all filter controls
          document.getElementById('sort-by').value = 'firstName';
          document.getElementById('sort-order').value = 'asc';
          document.getElementById('department-filter').value = '';
          document.getElementById('year-filter').value = '';
          document.getElementById('status-filter').value = '';
          document.getElementById('risk-filter').value = '';
          document.getElementById('student-search').value = '';
          
          // Reload all students
          loadStudents().then(() => {
            updateStudentList();
            updateFilterResults();
          });
        });
      }

      // Auto-apply filters when dropdowns change
      const filterControls = ['sort-by', 'sort-order', 'department-filter', 'year-filter', 'status-filter', 'risk-filter'];
      filterControls.forEach(id => {
        const control = document.getElementById(id);
        if (control) {
          control.addEventListener('change', () => {
            loadFilteredStudents();
          });
        }
      });
      */

      // Modal close
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const modal = btn.closest('.modal');
          modal?.classList.remove('active');
        });
      });
      
      console.log('Event listeners set up successfully');
      
      // Fallback: Direct click handlers for each tab
      const tabButtons = {
        'overview': () => switchToTab('overview'),
        'status-students': () => {
          switchToTab('status-students');
          loadStatusStudents();
        },
        'courses': () => switchToTab('courses'),
        'analytics': () => switchToTab('analytics')
      };
      
      // Add direct click handlers
      Object.keys(tabButtons).forEach(tabId => {
        const button = document.querySelector(`[data-tab="${tabId}"]`);
        if (button) {
          button.onclick = (e) => {
            e.preventDefault();
            tabButtons[tabId]();
          };
        }
      });

      // At-risk students card click handler
      /*
      const atRiskCard = document.getElementById('at-risk-card');
      if (atRiskCard) {
        atRiskCard.addEventListener('click', openAtRiskModal);
      }
      */
    }
    
    function switchToTab(tabId) {
      console.log('Switching to tab:', tabId);
      
      // Remove active class from all tabs and content
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Add active class to clicked tab and corresponding content
      const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
      const tabContent = document.getElementById(tabId);
      
      if (tabButton && tabContent) {
        tabButton.classList.add('active');
        tabContent.classList.add('active');
        console.log('Successfully switched to tab:', tabId);
      } else {
        console.error('Tab button or content not found:', tabId);
      }
    }

    function updateStudentListWithData(studentData) {
      /*
      // Ensure studentData is an array
      if (!Array.isArray(studentData)) {
        console.warn('Student data is not an array:', studentData);
        studentData = [];
      }
      
      const studentList = document.getElementById('student-list');
      if (!studentList) return;
      
      studentList.innerHTML = '';

      studentData.forEach(student => {
        const riskLevel = student.riskScore > 0.7 ? 'danger' : student.riskScore > 0.4 ? 'warning' : 'success';
        const riskText = student.riskScore > 0.7 ? 'At Risk' : student.riskScore > 0.4 ? 'Monitor' : 'On Track';
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${student.firstName || student.first_name} ${student.lastName || student.last_name}</div>
            <div class="student-details">ID: ${student.studentId || student.student_id} â€¢ ${student.major} â€¢ GPA: ${student.academic?.gpa || 'N/A'}</div>
          </div>
          <span class="chip ${riskLevel}">${riskText}</span>
        `;
        studentItem.onclick = () => openStudentModal(student);
        studentList.appendChild(studentItem);
      });
      */
    }


    function openStudentModal(student) {
      /*
      document.getElementById('modal-student-name').textContent = `${student.firstName || student.first_name} ${student.lastName || student.last_name}`;
      document.getElementById('modal-student-id').textContent = student.studentId || student.student_id;
      document.getElementById('modal-student-major').textContent = student.major;
      document.getElementById('modal-student-gpa').textContent = student.academic?.gpa || 'N/A';
      document.getElementById('modal-student-year').textContent = student.year;
      document.getElementById('modal-student-status').textContent = student.enrollmentStatus;
      
      document.getElementById('student-modal').classList.add('active');
      */
    }

    function openAddStudentModal() {
      document.getElementById('add-student-modal').classList.add('active');
    }

    function openCourseModal() {
      document.getElementById('course-modal').classList.add('active');
    }

    function openReportModal() {
      document.getElementById('report-modal').classList.add('active');
    }

    async function generateReport() {
      const reportType = document.getElementById('report-type').value;
      const startDate = document.getElementById('start-date').value;
      const endDate = document.getElementById('end-date').value;
      
      const resultsEl = document.getElementById('report-results');
      if (resultsEl) {
        resultsEl.textContent = 'Generating...';
      }

      if (!startDate || !endDate) {
        if (resultsEl) resultsEl.textContent = 'Please select a valid date range';
        return;
      }

      try {
        if (reportType === 'retention') {
          const url = `${API_BASE_URL}/api/data/csv-retention?start=${startDate}&end=${endDate}`;
          const resp = await fetch(url);
          if (!resp.ok) {
            if (resp.status === 404) {
              const fallback = await fetch(`${API_BASE_URL}/api/data/csv-stats`);
              if (fallback.ok) {
                const stats = await fallback.json();
                if (resultsEl) {
                  const rr = typeof stats.retentionRate === 'number' ? stats.retentionRate : 0;
                  resultsEl.innerHTML = `
                    <div style=\"margin-top:10px\">
                      <div><strong>Range:</strong> ${startDate} â†’ ${endDate}</div>
                      <div><strong>Overall Retention Rate (fallback):</strong> ${rr}%</div>
                      <div style=\"color:#9ca3af\">Date-range endpoint not found (404). Showing overall retention.</div>
                    </div>
                  `;
                }
                return;
              }
            }
            throw new Error(`Failed to generate report (${resp.status})`);
          }
          const data = await resp.json();
          if (resultsEl) {
            // Prefer cohort-based fields if present
            if (typeof data.cohortSize === 'number' && typeof data.retainedCount === 'number') {
              resultsEl.innerHTML = `
                <div style=\"margin-top:10px\">
                  <div><strong>Range:</strong> ${data.start} â†’ ${data.end}</div>
                  <div><strong>Subsequent Window:</strong> ${data.windowDays} days</div>
                  <div><strong>Initial Cohort:</strong> ${data.cohortSize}</div>
                  <div><strong>Students Retained:</strong> ${data.retainedCount}</div>
                  <div><strong>Retention Rate:</strong> ${data.retentionRate}%</div>
                </div>
              `;
            } else {
              // Backward compatibility with earlier response structure
              resultsEl.innerHTML = `
                <div style=\"margin-top:10px\">
                  <div><strong>Range:</strong> ${data.start} â†’ ${data.end}</div>
                  <div><strong>Total Students:</strong> ${data.totalStudents ?? 0}</div>
                  <div><strong>Active Students in Range:</strong> ${data.activeStudentsInRange ?? 0}</div>
                  <div><strong>Retention Rate:</strong> ${data.retentionRate ?? 0}%</div>
                </div>
              `;
            }
          }
        } else {
          // Placeholder for other report types
          if (resultsEl) resultsEl.textContent = `Report ${reportType} is not implemented yet.`;
        }
      } catch (err) {
        if (resultsEl) resultsEl.textContent = `Error: ${err.message}`;
      }
    }

    function openAtRiskModal() {
      /*
      const modal = document.getElementById('at-risk-modal');
      modal.classList.add('active');
      loadAtRiskStudents();
      */
    }

    // ---------- Analytics Charts ----------
    let retentionChart, performanceChart, riskChart, riskBreakdownChart, majorDistributionChart, yearDistributionChart;

    function maybeRenderAnalyticsCharts() {
      const analyticsTab = document.getElementById('analytics');
      if (analyticsTab && analyticsTab.classList.contains('active')) {
        renderRetentionChart();
        renderPerformanceChart();
        renderRiskChart();
        renderRiskBreakdownChart();
        renderMajorDistributionChart();
        renderYearDistributionChart();
      }
    }

    // Wire nav tabs to render when analytics becomes active
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.nav-tab');
      if (!btn) return;
      const tabId = btn.getAttribute('data-tab');
      if (tabId === 'analytics') {
        // Slight delay to ensure canvas is laid out
        setTimeout(maybeRenderAnalyticsCharts, 0);
      } else if (tabId === 'status-students') {
        // Load Students Status s when tab is clicked
        loadStatusStudents();
      }
    });

    // Add real-time search for Students Status s
    document.addEventListener('DOMContentLoaded', () => {
      const statusSearch = document.getElementById('status-search');
      if (statusSearch) {
        statusSearch.addEventListener('input', () => {
          applyStatusFilters();
        });
      }
    });

    async function renderRetentionChart() {
      const canvas = document.getElementById('retentionChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-stats`);
        if (!resp.ok) throw new Error('stats fail');
        const stats = await resp.json();
        const rate = typeof stats.retentionRate === 'number' ? stats.retentionRate : 0;
        const notRetained = Math.max(0, 100 - rate);

        const data = {
          labels: ['Retained', 'Not Retained'],
          datasets: [{
            data: [rate, notRetained],
            backgroundColor: ['#10b981', '#ef4444'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        };

        if (retentionChart) retentionChart.destroy();
        retentionChart = new Chart(ctx, {
          type: 'doughnut',
          data,
          options: {
            cutout: '65%',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                display: true,
                position: 'bottom',
                labels: {
                  padding: 15,
                  font: { size: 12, weight: '600' },
                  usePointStyle: true
                }
              },
              tooltip: { 
                enabled: true,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    return `${label}: ${value.toFixed(1)}%`;
                  }
                }
              },
              title: {
                display: true,
                text: `${rate.toFixed(1)}% Retention Rate`,
                position: 'top',
                font: { size: 16, weight: 'bold' },
                color: '#1f2937'
              }
            }
          },
          plugins: [{
            id: 'centerText',
            beforeDraw: function(chart) {
              const ctx = chart.ctx;
              const centerX = chart.chartArea.left + (chart.chartArea.right - chart.chartArea.left) / 2;
              const centerY = chart.chartArea.top + (chart.chartArea.bottom - chart.chartArea.top) / 2;
              
              ctx.save();
              ctx.font = 'bold 32px system-ui';
              ctx.fillStyle = '#1f2937';
              ctx.textAlign = 'center';
              ctx.textBaseline = 'middle';
              ctx.fillText(`${rate.toFixed(1)}%`, centerX, centerY - 10);
              
              ctx.font = '14px system-ui';
              ctx.fillStyle = '#6b7280';
              ctx.fillText('Retention', centerX, centerY + 15);
              ctx.restore();
            }
          }]
        });
      } catch (error) {
        console.error('Error rendering retention chart:', error);
      }
    }

    async function renderPerformanceChart() {
      const canvas = document.getElementById('performanceChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (!resp.ok) throw new Error('students fail');
        const data = await resp.json();

        // GPA bands with risk-based colors
        const bands = [
          { label: '<2.0', min: -Infinity, max: 2.0, color: '#dc2626' },
          { label: '2.0-2.5', min: 2.0, max: 2.5, color: '#ea580c' },
          { label: '2.5-3.0', min: 2.5, max: 3.0, color: '#f59e0b' },
          { label: '3.0-3.5', min: 3.0, max: 3.5, color: '#3b82f6' },
          { label: '3.5-4.0', min: 3.5, max: 4.01, color: '#10b981' }
        ];
        const counts = bands.map(b => 0);
        let totalStudents = 0;
        
        for (const s of data) {
          const g = s?.academic?.gpa ?? 0;
          if (g > 0) {
            totalStudents++;
            for (let i = 0; i < bands.length; i++) {
              const b = bands[i];
              if (g >= b.min && g < b.max) { counts[i]++; break; }
            }
          }
        }

        if (performanceChart) performanceChart.destroy();
        performanceChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: bands.map(b => b.label),
            datasets: [{
              label: 'Number of Students',
              data: counts,
              backgroundColor: bands.map(b => b.color),
              borderColor: bands.map(b => b.color),
              borderWidth: 2,
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                display: true,
                position: 'top',
                labels: {
                  font: { size: 11 },
                  padding: 10
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    const value = context.parsed.y;
                    const percentage = totalStudents > 0 ? ((value / totalStudents) * 100).toFixed(1) : 0;
                    return `${value} students (${percentage}%)`;
                  },
                  afterLabel: function(context) {
                    const label = context.label;
                    if (label === '<2.0' || label === '2.0-2.5' || (label === '2.5-3.0')) {
                      return 'âš ï¸ High Risk';
                    } else if (label === '3.0-3.5') {
                      return 'âš ï¸ Medium Risk';
                    } else {
                      return 'âœ“ Low Risk';
                    }
                  }
                }
              },
              title: {
                display: true,
                text: `GPA Distribution (Total: ${totalStudents} students)`,
                position: 'top',
                font: { size: 14, weight: 'bold' },
                color: '#1f2937',
                padding: { bottom: 15 }
              }
            },
            scales: {
              x: { 
                grid: { display: false },
                ticks: {
                  font: { size: 11, weight: '600' },
                  color: '#374151'
                },
                title: {
                  display: true,
                  text: 'GPA Range',
                  font: { size: 12, weight: 'bold' },
                  color: '#6b7280'
                }
              },
              y: { 
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 11 },
                  color: '#6b7280'
                },
                grid: {
                  color: '#e5e7eb',
                  lineWidth: 1
                },
                title: {
                  display: true,
                  text: 'Number of Students',
                  font: { size: 12, weight: 'bold' },
                  color: '#6b7280'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering performance chart:', error);
      }
    }

    async function renderRiskChart() {
      const canvas = document.getElementById('riskChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (!resp.ok) throw new Error('students fail');
        const data = await resp.json();

        console.log('Risk Chart - Total students loaded:', data.length);

        // Count students by risk level and major
        const riskByMajor = new Map();
        const majorTotals = new Map();
        
        for (const s of data) {
          const g = parseFloat(s?.academic?.gpa) || 0;
          // Get major field - CSV returns it as 'major'
          const major = s.major || 'Unknown';
          
          // Count total students per major
          majorTotals.set(major, (majorTotals.get(major) || 0) + 1);
          
          // Count high-risk students (GPA <= 2.9)
          if (g > 0 && g <= 2.9) {
            riskByMajor.set(major, (riskByMajor.get(major) || 0) + 1);
          }
        }

        console.log('Risk Chart - High risk students by major:', Array.from(riskByMajor.entries()));
        console.log('Risk Chart - Total majors:', majorTotals.size);

        // If no high-risk students found, show all majors with 0 high-risk
        let sortedEntries;
        if (riskByMajor.size === 0) {
          // Show all majors with 0 high-risk students
          sortedEntries = Array.from(majorTotals.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10)
            .map(([major]) => [major, 0]);
        } else {
          // Sort by number of high-risk students (descending)
          sortedEntries = Array.from(riskByMajor.entries())
            .sort((a, b) => b[1] - a[1])
            .slice(0, 10); // Show top 10 majors
        }

        const labels = sortedEntries.map(([major]) => major);
        const highRiskCounts = sortedEntries.map(([, count]) => count);
        const totalCounts = sortedEntries.map(([major]) => majorTotals.get(major) || 0);
        const percentages = sortedEntries.map(([major], idx) => {
          const total = totalCounts[idx] || 1;
          return ((highRiskCounts[idx] / total) * 100).toFixed(1);
        });

        console.log('Risk Chart - Labels:', labels);
        console.log('Risk Chart - Counts:', highRiskCounts);

        if (riskChart) riskChart.destroy();
        
        // If no data, show a message
        if (labels.length === 0 || highRiskCounts.every(c => c === 0)) {
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.save();
          ctx.font = '16px system-ui';
          ctx.fillStyle = '#6b7280';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('No high-risk students found', canvas.width / 2, canvas.height / 2);
          ctx.restore();
          return;
        }

        riskChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'High Risk Students',
              data: highRiskCounts,
              backgroundColor: '#ef4444',
              borderColor: '#dc2626',
              borderWidth: 2,
              borderRadius: 6
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { 
                display: true,
                position: 'top',
                labels: {
                  font: { size: 11 },
                  padding: 10,
                  usePointStyle: true
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    const index = context.dataIndex;
                    const highRisk = highRiskCounts[index];
                    const total = totalCounts[index];
                    const percentage = percentages[index];
                    return [
                      `High Risk: ${highRisk} students`,
                      `Total in Major: ${total} students`,
                      `Risk Rate: ${percentage}%`
                    ];
                  }
                }
              },
              title: {
                display: true,
                text: 'High Risk Students by Major (GPA â‰¤ 2.9)',
                position: 'top',
                font: { size: 14, weight: 'bold' },
                color: '#1f2937',
                padding: { bottom: 15 }
              }
            },
            scales: {
              x: { 
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 11 },
                  color: '#6b7280',
                  precision: 0
                },
                grid: {
                  color: '#e5e7eb',
                  lineWidth: 1
                },
                title: {
                  display: true,
                  text: 'Number of High Risk Students',
                  font: { size: 12, weight: 'bold' },
                  color: '#6b7280'
                }
              },
              y: { 
                grid: { 
                  display: false
                },
                ticks: {
                  font: { size: 11, weight: '600' },
                  color: '#374151'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering risk chart:', error);
        // Show error message on canvas
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();
        ctx.font = '14px system-ui';
        ctx.fillStyle = '#ef4444';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('Error loading chart data', canvas.width / 2, canvas.height / 2);
        ctx.restore();
      }
    }

    async function renderRiskBreakdownChart() {
      const canvas = document.getElementById('riskBreakdownChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (!resp.ok) throw new Error('students fail');
        const data = await resp.json();

        let highRisk = 0, mediumRisk = 0, noRisk = 0;
        
        for (const s of data) {
          const g = s?.academic?.gpa ?? 0;
          if (g >= 0 && g <= 2.9) {
            highRisk++;
          } else if (g >= 3.0 && g <= 3.2) {
            mediumRisk++;
          } else if (g > 3.2) {
            noRisk++;
          }
        }

        if (riskBreakdownChart) riskBreakdownChart.destroy();
        riskBreakdownChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['High Risk (0-2.9)', 'Medium Risk (3.0-3.2)', 'No Risk (>3.2)'],
            datasets: [{
              data: [highRisk, mediumRisk, noRisk],
              backgroundColor: ['#ef4444', '#f59e0b', '#10b981'],
              borderColor: '#fff',
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  padding: 15,
                  font: { size: 12, weight: '600' },
                  usePointStyle: true
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const total = highRisk + mediumRisk + noRisk;
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} students (${percentage}%)`;
                  }
                }
              },
              title: {
                display: true,
                text: `Risk Level Distribution (Total: ${highRisk + mediumRisk + noRisk} students)`,
                position: 'top',
                font: { size: 14, weight: 'bold' },
                color: '#1f2937',
                padding: { bottom: 15 }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering risk breakdown chart:', error);
      }
    }

    async function renderMajorDistributionChart() {
      const canvas = document.getElementById('majorDistributionChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (!resp.ok) throw new Error('students fail');
        const data = await resp.json();

        const majorCounts = new Map();
        for (const s of data) {
          const major = s.major || 'Unknown';
          majorCounts.set(major, (majorCounts.get(major) || 0) + 1);
        }

        const sortedEntries = Array.from(majorCounts.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 8);

        const labels = sortedEntries.map(([major]) => major);
        const counts = sortedEntries.map(([, count]) => count);

        if (majorDistributionChart) majorDistributionChart.destroy();
        majorDistributionChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Number of Students',
              data: counts,
              backgroundColor: '#6366f1',
              borderColor: '#4f46e5',
              borderWidth: 2,
              borderRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    return `${context.parsed.y} students`;
                  }
                }
              },
              title: {
                display: true,
                text: 'Student Enrollment by Major',
                position: 'top',
                font: { size: 14, weight: 'bold' },
                color: '#1f2937',
                padding: { bottom: 15 }
              }
            },
            scales: {
              x: {
                grid: { display: false },
                ticks: {
                  font: { size: 10 },
                  color: '#374151',
                  maxRotation: 45,
                  minRotation: 45
                }
              },
              y: {
                beginAtZero: true,
                ticks: {
                  stepSize: 1,
                  font: { size: 11 },
                  color: '#6b7280'
                },
                grid: {
                  color: '#e5e7eb',
                  lineWidth: 1
                }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering major distribution chart:', error);
      }
    }

    async function renderYearDistributionChart() {
      const canvas = document.getElementById('yearDistributionChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');

      try {
        const resp = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (!resp.ok) throw new Error('students fail');
        const data = await resp.json();

        const yearCounts = {
          'First Year': 0,
          'Second Year': 0,
          'Third Year': 0,
          'Fourth Year': 0,
          'Graduate': 0
        };

        for (const s of data) {
          const year = s.year || 'Unknown';
          if (yearCounts.hasOwnProperty(year)) {
            yearCounts[year]++;
          }
        }

        const labels = Object.keys(yearCounts);
        const counts = Object.values(yearCounts);
        const colors = ['#3b82f6', '#8b5cf6', '#ec4899', '#f59e0b', '#10b981'];

        if (yearDistributionChart) yearDistributionChart.destroy();
        yearDistributionChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [{
              data: counts,
              backgroundColor: colors,
              borderColor: '#fff',
              borderWidth: 3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                display: true,
                position: 'bottom',
                labels: {
                  padding: 12,
                  font: { size: 11, weight: '600' },
                  usePointStyle: true
                }
              },
              tooltip: {
                enabled: true,
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed || 0;
                    const total = counts.reduce((a, b) => a + b, 0);
                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                    return `${label}: ${value} students (${percentage}%)`;
                  }
                }
              },
              title: {
                display: true,
                text: `Year Distribution (Total: ${counts.reduce((a, b) => a + b, 0)} students)`,
                position: 'top',
                font: { size: 14, weight: 'bold' },
                color: '#1f2937',
                padding: { bottom: 15 }
              }
            }
          }
        });
      } catch (error) {
        console.error('Error rendering year distribution chart:', error);
      }
    }

    function loadAtRiskStudents() {
      /*
      const atRiskList = document.getElementById('at-risk-list');
      atRiskList.innerHTML = '<div class="loading">Loading at-risk students...</div>';
      
      // Filter students with GPA 0.0 - 2.99 (High Risk)
      const atRiskStudents = students.filter(s => {
        const gpa = s.academic?.gpa || 0;
        return gpa >= 0 && gpa <= 2.99;
      });
      
      if (atRiskStudents.length === 0) {
        atRiskList.innerHTML = '<div class="no-data">No at-risk students found.</div>';
        return;
      }
      
      atRiskList.innerHTML = '';
      atRiskStudents.forEach(student => {
        const gpa = student.academic?.gpa || 0;
        const absences = student.academic?.attendanceAbsences || 0;
        const credits = Math.min(student.academic?.creditsEarned || 0, 33); // Cap at 33
        
        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.innerHTML = `
          <div class="student-info">
            <div class="student-name">${student.firstName || student.first_name} ${student.lastName || student.last_name}</div>
            <div class="student-details">
              ID: ${student.studentId || student.student_id} â€¢ ${student.major} â€¢ ${student.year} â€¢ 
              GPA: ${gpa.toFixed(2)} â€¢ Credits: ${credits} â€¢ Absences: ${absences}
            </div>
            <div class="student-contact">
              ðŸ“§ ${student.email} â€¢ ðŸ“ž ${student.phone}
            </div>
            <div class="student-advisor">
              Advisor: ${student.assignedAdvisor ? `${student.assignedAdvisor.firstName} ${student.assignedAdvisor.lastName}` : 'Not Assigned'}
            </div>
          </div>
          <span class="chip danger">At Risk</span>
        `;
        studentItem.onclick = () => openStudentModal(student);
        atRiskList.appendChild(studentItem);
      });
      */
    }

    function addStudent() {
      /*
      const form = document.getElementById('add-student-form');
      const formData = new FormData(form);
      
      // In a real app, this would add the student to the database
      alert('Student added successfully!');
      document.getElementById('add-student-modal').classList.remove('active');
      form.reset();
      */
    }

    async function addCourse() {
      const form = document.getElementById('add-course-form');
      const formData = new FormData(form);
      
      const courseData = {
        course_code: formData.get('courseCode'),
        course_title: formData.get('courseName'),
        credits: parseInt(formData.get('credits')),
        department: formData.get('department'),
        description: formData.get('description') || ''
      };
      
      // Validate required fields
      if (!courseData.course_code || !courseData.course_title || !courseData.credits || !courseData.department) {
        alert('Please fill in all required fields');
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/courses`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(courseData)
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Course added successfully and saved to CSV!');
          document.getElementById('course-modal').classList.remove('active');
          form.reset();
          
          // Reload courses to show the new one
          await loadCourses();
        } else {
          alert('Failed to add course: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error adding course:', error);
        alert('Error adding course: ' + error.message);
      }
    }
    
    async function deleteCourse(courseId) {
      if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
        return;
      }
      
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/courses/${courseId}`, {
          method: 'DELETE'
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert('Course deleted successfully from CSV!');
          // Reload courses to update the list
          await loadCourses();
        } else {
          alert('Failed to delete course: ' + (result.error || 'Unknown error'));
        }
      } catch (error) {
        console.error('Error deleting course:', error);
        alert('Error deleting course: ' + error.message);
      }
    }

    // Students Status s Management Functions
    let statusStudents = [];
    let studentStatuses = {}; // Store student statuses in memory (in production, use database)

    // Load student statuses from localStorage
    function loadStudentStatuses() {
      const stored = localStorage.getItem('studentStatuses');
      if (stored) {
        try {
          studentStatuses = JSON.parse(stored);
        } catch (e) {
          studentStatuses = {};
        }
      }
    }

    // Save student statuses to localStorage
    function saveStudentStatuses() {
      localStorage.setItem('studentStatuses', JSON.stringify(studentStatuses));
    }

    // Get status for a student (default to 'pending')
    function getStudentStatus(studentId) {
      return studentStatuses[studentId] || 'pending';
    }

    // Set status for a student
    function setStudentStatus(studentId, status) {
      studentStatuses[studentId] = status;
      saveStudentStatuses();
    }

    async function loadStatusStudents() {
      const listContainer = document.getElementById('status-student-list');
      if (!listContainer) return;
      
      // Show loading state
      listContainer.innerHTML = '<div class="loading">Loading students...</div>';
      
      try {
        console.log('ðŸ“‹ Loading 5 students from CSV...');
        // Fetch only 5 students initially
        const csvResponse = await fetch(`${API_BASE_URL}/api/data/csv-students?limit=5`);
        if (csvResponse.ok) {
          const students = await csvResponse.json();
          console.log('âœ… Loaded', students.length, 'students from CSV');
          
          // Map CSV data to expected format
          const mappedStudents = students.map(s => ({
            studentId: s.student_id,
            student_id: s.student_id,
            firstName: s.firstName || s.first_name,
            first_name: s.firstName || s.first_name,
            lastName: s.lastName || s.last_name,
            last_name: s.lastName || s.last_name,
            email: s.email,
            phone: s.phone,
            major: s.major,
            year: s.year,
            academic: s.academic || { gpa: 0, creditsEarned: 0, attendanceAbsences: 0 },
            ...s
          }));
          
          // Don't store all students, just the 5 displayed
          statusStudents = [];
          loadStudentStatuses();
          // Get all majors for filter (need to fetch once for major filter)
          const allStudentsResponse = await fetch(`${API_BASE_URL}/api/data/csv-students`);
          if (allStudentsResponse.ok) {
            const allStudents = await allStudentsResponse.json();
            populateMajorFilter(allStudents);
          }
          updateStatusStudentList(mappedStudents);
        } else {
          console.error('âŒ Failed to load students for status:', csvResponse.status);
          listContainer.innerHTML = '<div class="list-item" style="text-align: center; color: #dc2626; padding: 20px;">Failed to load students. Please try refreshing the page.</div>';
        }
      } catch (error) {
        console.error('âŒ Error loading Students Status s:', error);
        if (listContainer) {
          listContainer.innerHTML = `<div class="list-item" style="text-align: center; color: #dc2626; padding: 20px;">Error loading students: ${error.message}</div>`;
        }
      }
    }

    function populateMajorFilter(students) {
      const majorFilter = document.getElementById('status-major-filter');
      if (!majorFilter) return;

      // Get unique majors
      const majors = [...new Set(students.map(s => s.major || s.major).filter(Boolean))].sort();
      
      // Clear existing options except "All Majors"
      majorFilter.innerHTML = '<option value="">All Majors</option>';
      
      majors.forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        majorFilter.appendChild(option);
      });
    }

    function updateStatusStudentList(students) {
      const listContainer = document.getElementById('status-student-list');
      if (!listContainer) return;

      listContainer.innerHTML = '';

      if (students.length === 0) {
        listContainer.innerHTML = '<div class="list-item" style="text-align: center; color: #6b7280;">No students found</div>';
        return;
      }
      
      // Show info message if only 5 students are displayed (initial load, no search)
      const searchTerm = document.getElementById('status-search')?.value.trim() || '';
      if (!searchTerm && students.length === 5) {
        const limitMessage = document.createElement('div');
        limitMessage.className = 'list-item';
        limitMessage.style.cssText = 'text-align: center; color: #6b7280; padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 12px; font-size: 13px;';
        limitMessage.innerHTML = `Showing 5 students. Use the search bar to find specific students.`;
        listContainer.appendChild(limitMessage);
      }

      students.forEach(student => {
        // Parse GPA properly
        let gpa = student.academic?.gpa;
        if (gpa === null || gpa === undefined || isNaN(gpa)) {
          gpa = 0;
        } else {
          gpa = parseFloat(gpa);
          if (isNaN(gpa)) {
            gpa = 0;
          }
        }
        
        const studentId = student.studentId || student.student_id;
        const firstName = student.firstName || student.first_name || '';
        const lastName = student.lastName || student.last_name || '';
        const email = student.email || '';
        const major = student.major || 'N/A';
        const year = student.year || 'N/A';
        
        // Use riskScore from database if available, otherwise calculate from GPA
        let risk, currentRiskLevel;
        if (student.riskScore !== undefined && student.riskScore !== null) {
          // Use database risk score
          if (student.riskScore >= 50) {
            risk = { level: 'danger', text: 'High Risk' };
            currentRiskLevel = 'high';
          } else if (student.riskScore >= 25) {
            risk = { level: 'warning', text: 'Medium Risk' };
            currentRiskLevel = 'medium';
          } else {
            risk = { level: 'success', text: 'No Risk' };
            currentRiskLevel = 'low';
          }
        } else {
          // Fallback to GPA-based calculation
          risk = calculateRiskLevel(gpa);
          if (risk.level === 'danger') {
            currentRiskLevel = 'high';
          } else if (risk.level === 'warning') {
            currentRiskLevel = 'medium';
          } else {
            currentRiskLevel = 'low';
          }
        }
        
        const status = getStudentStatus(studentId);

        const studentItem = document.createElement('div');
        studentItem.className = 'list-item';
        studentItem.style.cursor = 'default';
        studentItem.innerHTML = `
          <div class="student-info" style="flex: 1;">
            <div class="student-name">${escapeHtml(firstName)} ${escapeHtml(lastName)}</div>
            <div class="student-details">
              ID: ${studentId} â€¢ ${escapeHtml(major)} â€¢ ${escapeHtml(year)} â€¢ GPA: ${gpa.toFixed(2)}
            </div>
            ${email ? `<div class="student-contact" style="font-size: 12px; color: #6b7280; margin-top: 4px;">ðŸ“§ ${escapeHtml(email)}</div>` : ''}
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <span class="chip ${risk.level}">${risk.text}</span>
          </div>
        `;
        listContainer.appendChild(studentItem);
      });
    }

    function updateStudentStatus(studentId, newStatus) {
      setStudentStatus(studentId, newStatus);
      // Optionally show a notification
      console.log(`Student ${studentId} status updated to: ${newStatus}`);
    }

    async function applyStatusFilters() {
      const listContainer = document.getElementById('status-student-list');
      const searchTerm = document.getElementById('status-search')?.value.trim() || '';
      const riskFilter = document.getElementById('status-risk-filter')?.value || '';
      const majorFilter = document.getElementById('status-major-filter')?.value || '';

      // If there's a search term, fetch from CSV
      if (searchTerm) {
        if (listContainer) {
          listContainer.innerHTML = '<div class="loading">Searching students...</div>';
        }
        try {
          console.log('ðŸ” Searching students in CSV:', searchTerm);
          const response = await fetch(`${API_BASE_URL}/api/data/csv-students?search=${encodeURIComponent(searchTerm)}`);
          if (response.ok) {
            const students = await response.json();
            console.log('âœ… Found', students.length, 'matching students');
            
            // Map CSV data to expected format
            let filtered = students.map(s => ({
              studentId: s.student_id,
              student_id: s.student_id,
              firstName: s.firstName || s.first_name,
              first_name: s.firstName || s.first_name,
              lastName: s.lastName || s.last_name,
              last_name: s.lastName || s.last_name,
              email: s.email,
              phone: s.phone,
              major: s.major,
              year: s.year,
              academic: s.academic || { gpa: 0, creditsEarned: 0, attendanceAbsences: 0 },
              ...s
            }));
            
            // Apply risk filter
            if (riskFilter) {
              filtered = filtered.filter(s => {
                let gpa = s.academic?.gpa;
                if (gpa === null || gpa === undefined || isNaN(gpa)) {
                  gpa = 0;
                } else {
                  gpa = parseFloat(gpa);
                  if (isNaN(gpa)) {
                    gpa = 0;
                  }
                }
                const risk = calculateRiskLevel(gpa);
                if (riskFilter === 'high') return risk.level === 'danger';
                if (riskFilter === 'medium') return risk.level === 'warning';
                if (riskFilter === 'no') return risk.level === 'success';
                return true;
              });
            }
            
            // Apply major filter
            if (majorFilter) {
              filtered = filtered.filter(s => (s.major || '') === majorFilter);
            }
            
            updateStatusStudentList(filtered);
            return;
          }
        } catch (error) {
          console.error('âŒ Error searching students:', error);
        }
      }
      
      // If no search term, apply filters to currently displayed students or reload 5
      if (!searchTerm) {
        // Reload 5 students and apply filters
        try {
          const response = await fetch(`${API_BASE_URL}/api/data/csv-students?limit=5`);
          if (response.ok) {
            const students = await response.json();
            let filtered = students.map(s => ({
              studentId: s.student_id,
              student_id: s.student_id,
              firstName: s.firstName || s.first_name,
              first_name: s.firstName || s.first_name,
              lastName: s.lastName || s.last_name,
              last_name: s.lastName || s.last_name,
              email: s.email,
              phone: s.phone,
              major: s.major,
              year: s.year,
              academic: s.academic || { gpa: 0, creditsEarned: 0, attendanceAbsences: 0 },
              ...s
            }));
            
            // Apply risk filter
            if (riskFilter) {
              filtered = filtered.filter(s => {
                let gpa = s.academic?.gpa;
                if (gpa === null || gpa === undefined || isNaN(gpa)) {
                  gpa = 0;
                } else {
                  gpa = parseFloat(gpa);
                  if (isNaN(gpa)) {
                    gpa = 0;
                  }
                }
                const risk = calculateRiskLevel(gpa);
                if (riskFilter === 'high') return risk.level === 'danger';
                if (riskFilter === 'medium') return risk.level === 'warning';
                if (riskFilter === 'no') return risk.level === 'success';
                return true;
              });
            }
            
            // Apply major filter
            if (majorFilter) {
              filtered = filtered.filter(s => (s.major || '') === majorFilter);
            }
            
            updateStatusStudentList(filtered);
            return;
          }
        } catch (error) {
          console.error('âŒ Error loading students:', error);
        }
      }
      
    }

    async function clearStatusFilters() {
      document.getElementById('status-search').value = '';
      document.getElementById('status-risk-filter').value = '';
      document.getElementById('status-major-filter').value = '';
      // When clearing filters, reload 5 students
      await loadStatusStudents();
    }

    // My Students Filter Functions
    function populateMyStudentsMajorFilter(students) {
      const majorFilter = document.getElementById('my-students-major-filter');
      if (!majorFilter) return;
      
      // Get unique majors from students
      const majors = [...new Set(students.map(s => s.major || s.major).filter(Boolean))].sort();
      
      // Clear existing options except "All Majors"
      majorFilter.innerHTML = '<option value="">All Majors</option>';
      
      // Add major options
      majors.forEach(major => {
        const option = document.createElement('option');
        option.value = major;
        option.textContent = major;
        majorFilter.appendChild(option);
      });
    }

    function applyMyStudentsFilters() {
      if (!myStudentsData || myStudentsData.length === 0) {
        return;
      }
      
      const searchTerm = document.getElementById('my-students-search')?.value.trim() || '';
      const riskFilter = document.getElementById('my-students-risk-filter')?.value || '';
      const majorFilter = document.getElementById('my-students-major-filter')?.value || '';
      
      let filtered = [...myStudentsData];
      
      // Apply search filter
      if (searchTerm) {
        const searchLower = searchTerm.toLowerCase();
        filtered = filtered.filter(student => {
          const name = `${student.firstName || student.first_name} ${student.lastName || student.last_name}`.toLowerCase();
          const id = String(student.studentId || student.student_id).toLowerCase();
          return name.includes(searchLower) || id.includes(searchLower);
        });
      }
      
      // Apply risk filter
      if (riskFilter) {
        filtered = filtered.filter(s => {
          let gpa = s.academic?.gpa;
          if (gpa === null || gpa === undefined || isNaN(gpa)) {
            gpa = 0;
          } else {
            gpa = parseFloat(gpa);
            if (isNaN(gpa)) {
              gpa = 0;
            }
          }
          const risk = calculateRiskLevel(gpa);
          if (riskFilter === 'high') return risk.level === 'danger';
          if (riskFilter === 'medium') return risk.level === 'warning';
          if (riskFilter === 'no') return risk.level === 'success';
          return true;
        });
      }
      
      // Apply major filter
      if (majorFilter) {
        filtered = filtered.filter(s => (s.major || '') === majorFilter);
      }
      
      // Update the student list with filtered data
      updateStudentList(filtered);
    }

    function clearMyStudentsFilters() {
      document.getElementById('my-students-search').value = '';
      document.getElementById('my-students-risk-filter').value = '';
      document.getElementById('my-students-major-filter').value = '';
      // Show all students
      if (myStudentsData && myStudentsData.length > 0) {
        updateStudentList(myStudentsData);
      }
    }


    // Contact Student Functions
    function openContactStudentModal(studentId, studentName, studentEmail) {
      document.getElementById('contact-student-id').value = studentId;
      document.getElementById('contact-student-name').textContent = studentName;
      document.getElementById('contact-student-email').textContent = studentEmail ? `ðŸ“§ ${studentEmail}` : 'Email not available';
      document.getElementById('contact-student-modal').classList.add('active');
    }

    function closeContactStudentModal() {
      document.getElementById('contact-student-modal').classList.remove('active');
      document.getElementById('contact-student-form').reset();
    }

    async function submitContactStudent(event) {
      event.preventDefault();
      
      const form = event.target;
      const formData = new FormData(form);
      const studentId = formData.get('studentId');
      const advisorId = localStorage.getItem('advisorId');
      
      if (!advisorId) {
        alert('Please log in as an advisor to contact students');
        return;
      }
      
      const contactData = {
        studentId: parseInt(studentId),
        advisorId: advisorId,
        subject: formData.get('subject'),
        category: formData.get('category'),
        urgency: formData.get('urgency'),
        message: formData.get('message')
      };
      
      try {
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Sending...';
        
        const response = await fetch(`${API_BASE_URL}/api/entries`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            type: 'advisor-contact',
            data: contactData
          })
        });
        
        const result = await response.json();
        
        if (response.ok) {
          alert(`âœ… Message sent successfully to student!\n\nThe student has been notified and will see your message in their dashboard.`);
          closeContactStudentModal();
          // Optionally reload student list or show success indicator
        } else {
          throw new Error(result.error || 'Failed to send message');
        }
      } catch (error) {
        console.error('Error sending message to student:', error);
        alert(`âŒ Failed to send message: ${error.message}`);
      } finally {
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Send Message';
        }
      }
    }

    function openAddStudentToStatusModal() {
      document.getElementById('add-student-status-modal').classList.add('active');
      loadAvailableStudentsForAdd();
    }

    async function loadAvailableStudentsForAdd() {
      try {
        const response = await fetch(`${API_BASE_URL}/api/data/csv-students`);
        if (response.ok) {
          const students = await response.json();
          const select = document.getElementById('add-student-select');
          if (select) {
            select.innerHTML = '<option value="">Select a student...</option>';
            students.forEach(student => {
              const studentId = student.studentId || student.student_id;
              const option = document.createElement('option');
              option.value = studentId;
              option.textContent = `${student.firstName || student.first_name} ${student.lastName || student.last_name} (ID: ${studentId})`;
              select.appendChild(option);
            });
          }
        }
      } catch (error) {
        console.error('Error loading students for add:', error);
      }
    }

    function addStudentToStatus() {
      const select = document.getElementById('add-student-select');
      const studentId = select?.value;
      
      if (!studentId) {
        alert('Please select a student');
        return;
      }

      // Set initial status to 'pending'
      setStudentStatus(studentId, 'pending');
      
      // Reload the Students Status  list
      loadStatusStudents();
      
      // Close modal
      document.getElementById('add-student-status-modal').classList.remove('active');
      select.value = '';
      
      alert('Student added to status list!');
    }
  </script>
</head>
<body>
  <canvas id="particle-canvas" style="position:fixed;inset:0;pointer-events:none;z-index:9998;"></canvas>
  <div class="dashboard">
    <div class="header">
      <div class="title">
        <div id="avatar" class="avatar">A</div>
        <div>
          <h1 id="welcome">Welcome, Advisor</h1>
          <div id="advisor-id-line" class="meta">Loading...</div>
          <small>Student Retention Dashboard</small>
        </div>
      </div>
      <div class="header-actions">
        <a class="signout" href="index.html" onclick="
          localStorage.clear();
          sessionStorage.clear();
          // Prevent back button access
          window.location.replace('index.html');
          return false;
        ">Sign out</a>
      </div>
    </div>
    

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="overview">ðŸ“Š Overview</button>
      <button class="nav-tab" data-tab="status-students">ðŸ‘¥ Students Status</button>
      <button class="nav-tab" data-tab="courses">ðŸ“š Courses</button>
      <button class="nav-tab" data-tab="notifications">ðŸ”” Requests</button>
      <button class="nav-tab" data-tab="analytics">ðŸ“ˆ Analytics</button>
      <button class="nav-tab" data-tab="profile">ðŸ‘¤ Profile</button>
    </div>

    

    <!-- Courses Tab -->
    <div id="courses" class="tab-content">
      <div class="card">
        <h2><span class="card-icon">ðŸ“š</span>Course Management</h2>
        <div class="list" id="course-list">
          <!-- Courses will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Status Advisor Tab -->
    <div id="status-students" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><span class="card-icon">ðŸ‘¥</span>Students Status s</h2>
          <div style="display: flex; gap: 10px;">
            <button class="btn primary" onclick="openAddStudentToStatusModal()">Add Student</button>
          </div>
        </div>
        
        <!-- Filters Section -->
        <div class="card" style="background: #f9fafb; margin-bottom: 20px; padding: 20px;">
          <h3 style="font-size: 16px; margin-bottom: 16px; color: #1f2937;">Filters</h3>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div>
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #374151;">Search Student</label>
              <input type="text" id="status-search" placeholder="Name or ID..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #374151;">Risk Level</label>
              <select id="status-risk-filter" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">All Risk Levels</option>
                <option value="high">High Risk</option>
                <option value="medium">Medium Risk</option>
                <option value="no">No Risk</option>
              </select>
            </div>
            <div>
              <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #374151;">Major</label>
              <select id="status-major-filter" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                <option value="">All Majors</option>
              </select>
            </div>
          </div>
          <div style="display: flex; gap: 10px; margin-top: 16px;">
            <button class="btn primary" onclick="applyStatusFilters()">Apply Filters</button>
            <button class="btn secondary" onclick="clearStatusFilters()">Clear</button>
          </div>
        </div>
        
        <!-- Student Status List -->
        <div class="list" id="status-student-list">
          <!-- Students will be loaded here -->
        </div>
      </div>
    </div>

    <!-- Analytics Tab -->
    <!-- Requests Tab -->
    <div id="notifications" class="tab-content">
      <!-- Google Form Responses Section -->
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2><span class="card-icon">ðŸ“‹</span>Help Request Responses</h2>
          <div style="display: flex; gap: 8px;">
            <button class="btn secondary" onclick="loadGoogleFormResponses()">ðŸ”„ Refresh</button>
            <a href="https://docs.google.com/spreadsheets/d/1g-3Q2jvwappOkJ0snKnh5tSvK6w-E9kxCDnzdD35JDE/edit?resourcekey=&gid=2130650484#gid=2130650484" target="_blank" class="btn primary" style="text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
              ðŸ“Š Open Google Sheets
            </a>
          </div>
        </div>
        <div id="google-form-responses-list" class="list">
          <div class="loading">Loading help request responses...</div>
        </div>
      </div>
    </div>

    <div id="analytics" class="tab-content">
      <div class="grid-3">
        <div class="card">
          <h2><span class="card-icon">ðŸ“Š</span>Retention Rates</h2>
          <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">Overall student retention percentage showing retained vs. not retained students.</p>
          <div style="height:280px; position: relative;"><canvas id="retentionChart"></canvas></div>
          <div style="margin-top:12px"><button class="btn primary" onclick="openReportModal()">Generate Report</button></div>
        </div>
        <div class="card">
          <h2><span class="card-icon">ðŸ“ˆ</span>GPA Distribution</h2>
          <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">Distribution of students across different GPA ranges with risk indicators.</p>
          <div style="height:280px"><canvas id="performanceChart"></canvas></div>
        </div>
        <div class="card">
          <h2><span class="card-icon">ðŸŽ¯</span>Risk Analysis by Major</h2>
          <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">High-risk students (GPA â‰¤ 2.9) broken down by academic major.</p>
          <div style="height:280px"><canvas id="riskChart"></canvas></div>
        </div>
      </div>
      
      <!-- Additional Analytics Cards -->
      <div class="grid-3" style="margin-top: 24px;">
        <div class="card">
          <h2><span class="card-icon">ðŸ“‰</span>Risk Level Breakdown</h2>
          <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">Complete breakdown of students by risk level categories.</p>
          <div style="height:280px"><canvas id="riskBreakdownChart"></canvas></div>
        </div>
        <div class="card">
          <h2><span class="card-icon">ðŸ“š</span>Students by Major</h2>
          <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">Total number of students enrolled in each major program.</p>
          <div style="height:280px"><canvas id="majorDistributionChart"></canvas></div>
        </div>
        <div class="card">
          <h2><span class="card-icon">ðŸ“…</span>Year Distribution</h2>
          <p style="color: #6b7280; font-size: 13px; margin-bottom: 12px;">Student population distribution across academic years.</p>
          <div style="height:280px"><canvas id="yearDistributionChart"></canvas></div>
        </div>
      </div>
    </div>

    <!-- Profile Tab -->
    <div id="profile" class="tab-content">
      <div class="card">
        <h2><span class="card-icon">ðŸ‘¤</span>My Profile</h2>
        <div id="advisor-profile-section">
          <button id="edit-advisor-profile-btn" class="btn secondary" style="width: 100%; margin-bottom: 12px;" onclick="toggleAdvisorProfileEdit()">Edit Profile</button>
          <div id="advisor-profile-display">
            <div class="list-item"><strong>Name:</strong> <span id="advisor-profile-name">Loading...</span></div>
            <div class="list-item"><strong>Email:</strong> <span id="advisor-profile-email">Loading...</span></div>
            <div class="list-item"><strong>Phone:</strong> <span id="advisor-profile-phone">Loading...</span></div>
            <div class="list-item"><strong>Department:</strong> <span id="advisor-profile-department">Loading...</span></div>
            <div class="list-item"><strong>Specialization:</strong> <span id="advisor-profile-specialization">Loading...</span></div>
            <div class="list-item"><strong>Title:</strong> <span id="advisor-profile-title">Loading...</span></div>
            <div class="list-item"><strong>Office Location:</strong> <span id="advisor-profile-office">Loading...</span></div>
            <div class="list-item"><strong>Office Hours:</strong> <span id="advisor-profile-hours">Loading...</span></div>
            <div class="list-item"><strong>Address:</strong> <span id="advisor-profile-address">Loading...</span></div>
          </div>
          <div id="advisor-profile-edit" style="display: none;">
            <form class="form" id="advisor-profile-edit-form" onsubmit="saveAdvisorProfile(event)" style="display: grid; gap: 12px;">
              <div>
                <label>Name (cannot be changed)</label>
                <input type="text" id="edit-advisor-name" disabled style="background: #f3f4f6; cursor: not-allowed; width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label>Email (cannot be changed)</label>
                <input type="email" id="edit-advisor-email" disabled style="background: #f3f4f6; cursor: not-allowed; width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label for="edit-advisor-phone">Phone</label>
                <input type="tel" id="edit-advisor-phone" name="phone" placeholder="Enter phone number" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label for="edit-advisor-department">Department</label>
                <input type="text" id="edit-advisor-department" name="department" placeholder="Enter department" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label for="edit-advisor-specialization">Specialization</label>
                <input type="text" id="edit-advisor-specialization" name="specialization" placeholder="Enter specialization" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label for="edit-advisor-title">Title</label>
                <input type="text" id="edit-advisor-title" name="title" placeholder="Enter title" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label for="edit-advisor-office">Office Location</label>
                <input type="text" id="edit-advisor-office" name="officeLocation" placeholder="Enter office location" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label for="edit-advisor-hours">Office Hours</label>
                <input type="text" id="edit-advisor-hours" name="officeHours" placeholder="e.g., Mon-Fri 9am-5pm" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div>
                <label for="edit-advisor-address-street">Street Address</label>
                <input type="text" id="edit-advisor-address-street" name="address.street" placeholder="Enter street address" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label for="edit-advisor-address-city">City</label>
                  <input type="text" id="edit-advisor-address-city" name="address.city" placeholder="City" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
                </div>
                <div>
                  <label for="edit-advisor-address-state">State</label>
                  <input type="text" id="edit-advisor-address-state" name="address.state" placeholder="State" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
                </div>
              </div>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                <div>
                  <label for="edit-advisor-address-zip">Zip Code</label>
                  <input type="text" id="edit-advisor-address-zip" name="address.zipCode" placeholder="Zip Code" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
                </div>
                <div>
                  <label for="edit-advisor-address-country">Country</label>
                  <input type="text" id="edit-advisor-address-country" name="address.country" placeholder="Country" value="USA" style="width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px;" />
                </div>
              </div>
              <div style="display: flex; justify-content: end; gap: 10px; margin-top: 12px;">
                <button type="button" class="btn secondary" onclick="toggleAdvisorProfileEdit()">Cancel</button>
                <button type="submit" class="btn primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="total-students">0</div>
          <div class="stat-label">Total Students</div>
        </div>
        <div class="stat-card clickable" id="at-risk-card">
          <div class="stat-number" id="at-risk-students">0</div>
          <div class="stat-label">At Risk Students</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avg-gpa">0.00</div>
          <div class="stat-label">Average GPA</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="active-enrollments">0</div>
          <div class="stat-label">Active Enrollments</div>
        </div>
    </div>


    
        <div class="card">
          <h2><span class="card-icon">ðŸ‘¥</span>My Students</h2>
          
          <!-- Filters Section -->
          <div style="background: #f9fafb; margin-bottom: 20px; padding: 20px; border-radius: 12px;">
            <h3 style="font-size: 16px; margin-bottom: 16px; color: #1f2937;">Filters</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
              <div>
                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #374151;">Search Student</label>
                <input type="text" id="my-students-search" placeholder="Name or ID..." style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
              </div>
              <div>
                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #374151;">Risk Level</label>
                <select id="my-students-risk-filter" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                  <option value="">All Risk Levels</option>
                  <option value="high">High Risk</option>
                  <option value="medium">Medium Risk</option>
                  <option value="no">No Risk</option>
                </select>
              </div>
              <div>
                <label style="display: block; margin-bottom: 6px; font-size: 13px; font-weight: 600; color: #374151;">Major</label>
                <select id="my-students-major-filter" style="width: 100%; padding: 10px; border: 2px solid #e5e7eb; border-radius: 8px;">
                  <option value="">All Majors</option>
                </select>
              </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 16px;">
              <button class="btn primary" onclick="applyMyStudentsFilters()">Apply Filters</button>
              <button class="btn secondary" onclick="clearMyStudentsFilters()">Clear</button>
            </div>
          </div>
          
          <div class="list" id="student-list">
            <!-- Students will be loaded here -->
          </div>
        </div>
      </div>
    

    Advisor Tab
    
    <div id="students" class="tab-content">
      <div class="card">
        <h2><span class="card-icon">ðŸ‘¥</span>Students</h2>
        
        <!-- Advanced Filters -->
        
        <div class="filters-section" style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Sort by:</label>
              <select id="sort-by" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="firstName">Name</option>
                <option value="studentId">Student ID</option>
                <option value="major">Department</option>
                <option value="year">Year</option>
                <option value="enrollmentStatus">Enrollment Status</option>
                <option value="gpa">GPA</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Order:</label>
              <select id="sort-order" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="asc">Ascending</option>
                <option value="desc">Descending</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Department:</label>
              <select id="department-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Departments</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Engineering">Engineering</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Year:</label>
              <select id="year-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Years</option>
                <option value="First Year">First Year</option>
                <option value="Second Year">Second Year</option>
                <option value="Third Year">Third Year</option>
                <option value="Fourth Year">Fourth Year</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Status:</label>
              <select id="status-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Status</option>
                <option value="Enrolled">Enrolled</option>
                <option value="Graduated">Graduated</option>
                <option value="Suspended">Suspended</option>
              </select>
            </div>
            <div class="filter-group">
              <label style="display: block; margin-bottom: 5px; font-weight: 600; color: #374151;">Risk Level:</label>
              <select id="risk-filter" style="width: 100%; padding: 8px; border: 1px solid #d1d5db; border-radius: 6px;">
                <option value="">All Risk Levels</option>
                <option value="low">Low Risk</option>
                <option value="medium">Medium Risk</option>
                <option value="high">High Risk</option>
              </select>
            </div>
          </div>
          <div style="display: flex; gap: 10px; align-items: center;">
            <button id="apply-filters" class="btn primary" style="padding: 8px 16px;">Apply Filters</button>
            <button id="clear-filters" class="btn secondary" style="padding: 8px 16px;">Clear All</button>
            <span id="filter-results" style="color: #6b7280; font-size: 14px;"></span>
          </div>
        </div>

        <div class="list" id="student-list-detailed">
          <!-- Detailed student list will be loaded here -->
        </div>
      </div>
    </div>
    <!-- Advisor Tab commented out above -->

    

  </div>

  <!-- Student Detail Modal -->
  <!--
  <div id="student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Student Details</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="form">
        <div class="form-row">
          <div>
            <label>Name:</label>
            <input type="text" id="modal-student-name" readonly>
          </div>
          <div>
            <label>Student ID:</label>
            <input type="text" id="modal-student-id" readonly>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Major:</label>
            <input type="text" id="modal-student-major" readonly>
          </div>
          <div>
            <label>GPA:</label>
            <input type="text" id="modal-student-gpa" readonly>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Year:</label>
            <input type="text" id="modal-student-year" readonly>
          </div>
          <div>
            <label>Status:</label>
            <input type="text" id="modal-student-status" readonly>
          </div>
        </div>
        <div>
          <label>Notes:</label>
          <textarea placeholder="Add notes about this student..."></textarea>
        </div>
        <div class="actions">
          <button class="btn secondary" onclick="document.getElementById('student-modal').classList.remove('active')">Close</button>
          <button class="btn primary">Save Notes</button>
        </div>
      </div>
    </div>
  </div>
  <!-- Student Detail Modal commented out above -->

     <!-- Add Student Modal -->
   <!--
   <div id="add-student-modal" class="modal">
     <div class="modal-content">
       <div class="modal-header">
         <h2>Add New Student</h2>
         <button class="modal-close">&times;</button>
       </div>
       <form id="add-student-form" class="form">
         <div class="form-row">
           <div>
             <label>First Name:</label>
             <input type="text" name="firstName" required>
           </div>
           <div>
             <label>Last Name:</label>
             <input type="text" name="lastName" required>
           </div>
         </div>
         <div class="form-row">
           <div>
             <label>Student ID:</label>
             <input type="number" name="studentId" required>
           </div>
           <div>
             <label>Email:</label>
             <input type="email" name="email" required>
           </div>
         </div>
         <div class="form-row">
           <div>
             <label>Major:</label>
             <select name="major" required>
               <option value="Computer Science">Computer Science</option>
               <option value="Engineering">Engineering</option>
               <option value="Business">Business</option>
               <option value="Mathematics">Mathematics</option>
             </select>
           </div>
           <div>
             <label>Year:</label>
             <select name="year" required>
               <option value="2024">2024</option>
               <option value="2025">2025</option>
               <option value="2026">2026</option>
               <option value="2027">2027</option>
             </select>
           </div>
         </div>
         <div class="actions">
           <button type="button" class="btn secondary" onclick="document.getElementById('add-student-modal').classList.remove('active')">Cancel</button>
           <button type="button" class="btn primary" onclick="addStudent()">Add Student</button>
         </div>
       </form>
     </div>
   </div>
   <!-- Add Student Modal commented out above -->

  <!-- Add Course Modal -->
  <div id="course-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add New Course</h2>
        <button class="modal-close">&times;</button>
      </div>
      <form id="add-course-form" class="form">
        <div class="form-row">
          <div>
            <label>Course Code:</label>
            <input type="text" name="courseCode" required>
          </div>
          <div>
            <label>Course Name:</label>
            <input type="text" name="courseName" required>
          </div>
        </div>
        <div class="form-row">
          <div>
            <label>Department:</label>
            <select name="department" required>
              <option value="Computer Science">Computer Science</option>
              <option value="Engineering">Engineering</option>
              <option value="Business">Business</option>
              <option value="Mathematics">Mathematics</option>
            </select>
          </div>
          <div>
            <label>Credits:</label>
            <input type="number" name="credits" min="1" max="6" required>
          </div>
        </div>
        <div>
          <label>Description:</label>
          <textarea name="description" placeholder="Course description..."></textarea>
        </div>
        <div class="actions">
          <button type="button" class="btn secondary" onclick="document.getElementById('course-modal').classList.remove('active')">Cancel</button>
          <button type="button" class="btn primary" onclick="addCourse()">Add Course</button>
        </div>
          </form>
    </div>
  </div>

  <!-- Report Modal -->
  <div id="report-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Generate Report</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="form">
        <div>
          <label>Report Type:</label>
          <select id="report-type">
            <option value="retention">Retention Report</option>
            <option value="performance">Performance Report</option>
            <option value="risk">Risk Analysis Report</option>
            <option value="enrollment">Enrollment Report</option>
          </select>
        </div>
        <div class="form-row">
          <div>
            <label>Start Date:</label>
            <input type="date" id="start-date" required>
          </div>
          <div>
            <label>End Date:</label>
            <input type="date" id="end-date" required>
          </div>
        </div>
        <div class="actions">
          <button class="btn secondary" onclick="document.getElementById('report-modal').classList.remove('active')">Cancel</button>
          <button class="btn primary" onclick="generateReport()">Generate Report</button>
        </div>
        <div id="report-results" style="margin-top:12px;color:#374151;"></div>
      </div>
    </div>
  </div>

  <!-- At Risk Students Modal -->
  <!--
  <div id="at-risk-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>At Risk Students (GPA < 3.1)</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div id="at-risk-list" class="list">
        <div class="loading">Loading at-risk students...</div>
      </div>
    </div>
  </div>
  <!-- At Risk Students Modal commented out above -->

  <!-- Contact Student Modal -->
  <div id="contact-student-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Contact Student</h2>
        <button class="modal-close" onclick="closeContactStudentModal()">&times;</button>
      </div>
      <form id="contact-student-form" class="form" onsubmit="submitContactStudent(event)">
        <input type="hidden" id="contact-student-id" name="studentId">
        <div style="margin-bottom: 16px; padding: 12px; background: #f3f4f6; border-radius: 8px;">
          <div style="font-weight: 600; margin-bottom: 4px;" id="contact-student-name"></div>
          <div style="font-size: 13px; color: #6b7280;" id="contact-student-email"></div>
        </div>
        <div>
          <label>Subject <span style="color: #dc2626;">*</span></label>
          <input type="text" name="subject" required placeholder="e.g., Academic Progress Review" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
        </div>
        <div>
          <label>Category <span style="color: #dc2626;">*</span></label>
          <select name="category" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
            <option value="">Select category...</option>
            <option value="Academics">Academics</option>
            <option value="Financial">Financial</option>
            <option value="Housing">Housing</option>
            <option value="Career">Career</option>
            <option value="Personal">Personal</option>
            <option value="Other">Other</option>
          </select>
        </div>
        <div>
          <label>Urgency <span style="color: #dc2626;">*</span></label>
          <select name="urgency" required style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px;">
            <option value="Low">Low</option>
            <option value="Normal" selected>Normal</option>
            <option value="High">High</option>
          </select>
        </div>
        <div>
          <label>Message <span style="color: #dc2626;">*</span></label>
          <textarea name="message" required rows="5" placeholder="Enter your message to the student..." style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; resize: vertical;"></textarea>
        </div>
        <div class="actions">
          <button type="button" class="btn secondary" onclick="closeContactStudentModal()">Cancel</button>
          <button type="submit" class="btn primary">Send Message</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Student to Status Modal -->
  <div id="add-student-status-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Add Student to Status List</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="form">
        <div>
          <label>Select Student:</label>
          <select id="add-student-select" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 12px;">
            <option value="">Loading students...</option>
          </select>
        </div>
        <div class="actions">
          <button class="btn secondary" onclick="document.getElementById('add-student-status-modal').classList.remove('active')">Cancel</button>
          <button class="btn primary" onclick="addStudentToStatus()">Add Student</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>


