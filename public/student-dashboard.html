<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Student Dashboard</title>
  <link rel="stylesheet" href="../src/styles/variables.css" />
  <link rel="stylesheet" href="../src/styles/cursor.css" />
  <link rel="stylesheet" href="../src/styles/interactions.css" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
      min-height: 100vh;
      display: flex;
      align-items: start;
      justify-content: center;
      padding: 24px;
      color: #2a2a2a;
    }
    .dashboard {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 28px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
      width: 100%;
      max-width: 1100px;
    }
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .title {
      display: flex; gap: 12px; align-items: center;
    }
    .avatar {
      width: 44px; height: 44px; border-radius: 50%; background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; display: grid; place-items: center; font-weight: 700;
      box-shadow: 0 6px 16px rgba(118,75,162,0.35);
    }
    .header h1 { font-size: 22px; color: #333; }
    .header .meta { color: #666; font-size: 13px; margin-top: 2px; }
    .signout { color: #667eea; text-decoration: none; font-weight: 600; padding: 10px 14px; border-radius: 10px; background: rgba(102,126,234,.08); }
    .signout:hover { background: rgba(102,126,234,.15); }

    .grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 24px;
    }
    .left-column, .right-column {
      display: flex; flex-direction: column; gap: 20px;
    }
    .card { 
      background: #fff; 
      border: 1px solid #e8ecf2; 
      border-radius: 14px; 
      padding: 20px; 
      box-shadow: 0 8px 24px rgba(0,0,0,.06);
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .card:hover {
      transform: translateY(-2px);
      box-shadow: 0 12px 32px rgba(0,0,0,.1);
    }
    .card h2 { 
      font-size: 18px; 
      margin-bottom: 16px; 
      color: #333; 
      font-weight: 600;
      border-bottom: 2px solid #f0f0f0;
      padding-bottom: 12px;
    }
    .metrics { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px,1fr)); gap: 12px; }
    .metric { background: linear-gradient(135deg,#f7f9ff,#fff); border: 1px solid #e8ecf2; border-radius: 12px; padding: 14px; }
    .metric .label { color: #667; font-size: 12px; }
    .metric .value { font-size: 22px; font-weight: 700; margin-top: 6px; background: linear-gradient(135deg,#667eea,#764ba2); background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

    .list { display: grid; gap: 10px; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #eef1f6; border-radius: 10px; background: #fafbff; }
    .chip { padding: 4px 10px; border-radius: 999px; font-size: 12px; background: #eef2ff; color: #4f46e5; }
    .chip.success { background: #dcfce7; color: #166534; }
    .chip.warning { background: #fef3c7; color: #92400e; }
    .chip.danger { background: #fee2e2; color: #991b1b; }
    .chip.info { background: #dbeafe; color: #1e40af; }

    .form { display: grid; gap: 12px; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    label { font-size: 13px; color: #444; font-weight: 600; }
    input, select, textarea { width: 100%; padding: 12px 14px; border: 2px solid #e8ecf2; border-radius: 12px; background: #fff; font-size: 14px; }
    textarea { min-height: 110px; resize: vertical; }
    .actions { display: flex; justify-content: end; gap: 10px; }
    .btn { border: 0; border-radius: 12px; padding: 12px 16px; font-weight: 700; cursor: pointer; }
    .btn.primary { background: linear-gradient(135deg,#667eea,#764ba2); color: #fff; box-shadow: 0 8px 20px rgba(102,126,234,.3); }
    .btn.secondary { background: #eef2ff; color: #4f46e5; }

    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    
    .info-section {
      display: grid;
      gap: 20px;
    }
    
    @media (max-width: 1024px) { 
      .grid { 
        grid-template-columns: 1fr; 
      } 
      .metrics-grid { 
        grid-template-columns: repeat(2, 1fr); 
      } 
    }
    
    @media (max-width: 640px) { 
      .metrics-grid { 
        grid-template-columns: 1fr; 
      } 
    }
    
    .nav-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 30px;
      border-bottom: 2px solid #e5e7eb;
      flex-wrap: wrap;
    }
    .nav-tab {
      padding: 12px 20px;
      background: transparent;
      border: none;
      border-radius: 8px 8px 0 0;
      cursor: pointer;
      font-weight: 600;
      color: #6b7280;
      transition: all 0.3s ease;
      font-size: 14px;
    }
    .nav-tab.active {
      background: linear-gradient(135deg, #667eea, #764ba2);
      color: white;
    }
    .nav-tab:hover:not(.active) {
      background: rgba(102, 126, 234, 0.1);
    }
    
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
    }
  </style>
  <link rel="stylesheet" href="styles/theme.css" />
  <script type="module" src="../src/index.js"></script>
  <script>
    // Authentication check - must be first
    (function() {
      const studentId = localStorage.getItem('studentId');
      const studentSessionToken = localStorage.getItem('studentSessionToken');
      
      // If no authentication, redirect to login
      if (!studentId || !studentSessionToken) {
        // Clear any remaining data
        localStorage.clear();
        sessionStorage.clear();
        // Redirect to login
        window.location.href = 'index.html';
        return;
      }
    })();

    // Prevent back button access after logout
    window.addEventListener('pageshow', function(event) {
      // If page was loaded from cache (back button), check authentication
      if (event.persisted) {
        const studentId = localStorage.getItem('studentId');
        const studentSessionToken = localStorage.getItem('studentSessionToken');
        
        if (!studentId || !studentSessionToken) {
          localStorage.clear();
          sessionStorage.clear();
          window.location.href = 'index.html';
        }
      }
    });

    // Clear page from cache when navigating away
    window.addEventListener('beforeunload', function() {
      // This helps prevent back button access
    });

    // Utility function to escape HTML
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Tab switching function
    function switchTab(tabId) {
      // Remove active class from all tabs and content
      document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      // Add active class to selected tab and corresponding content
      const tabButton = document.querySelector(`[data-tab="${tabId}"]`);
      if (tabButton) {
        tabButton.classList.add('active');
      }
      
      const targetContent = document.getElementById(tabId);
      if (targetContent) {
        targetContent.classList.add('active');
        
        // Load data when switching to specific tabs
        const studentId = localStorage.getItem('studentId');
        if (tabId === 'courses' && studentId) {
          loadEnrollments(studentId);
        } else if (tabId === 'advisor' && studentId) {
          loadHelpRequests(studentId);
        }
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Double-check authentication on load
      const studentId = localStorage.getItem('studentId') || '';
      const studentSessionToken = localStorage.getItem('studentSessionToken') || '';
      
      if (!studentId || !studentSessionToken) {
        localStorage.clear();
        sessionStorage.clear();
        window.location.href = 'index.html';
        return;
      }
      
      let fullName = localStorage.getItem('fullName') || '';

      // If fullName not cached, fetch profile from backend
      if (!fullName && studentId){
        try {
          const res = await fetch(`${window.location.origin}/api/entries?type=student-profile&studentId=${encodeURIComponent(studentId)}&limit=1`);
          if (res.ok){
            const items = await res.json();
            const profile = items && items[0];
            if (profile && profile.data){
              fullName = profile.data.fullName || '';
              localStorage.setItem('fullName', fullName);
              if (profile.data.email) localStorage.setItem('email', profile.data.email);
              if (profile.data.major) localStorage.setItem('major', profile.data.major);
            }
          }
        } catch(e) {}
      }

      // Clean up fullName to remove "Not provided"
      if (fullName) {
        fullName = fullName.replace(/Not provided/gi, '').trim();
        // Remove extra spaces
        fullName = fullName.replace(/\s+/g, ' ');
      }
      
      const initials = (fullName || studentId || 'S').split(' ').filter(w => w && w.toLowerCase() !== 'not' && w.toLowerCase() !== 'provided').map(w => w[0]).join('').slice(0,2).toUpperCase();
      let displayName = fullName || initials || ('Student ' + studentId);
      // Remove "Not provided" from displayName if it exists
      displayName = displayName.replace(/Not provided/gi, '').trim();
      // If displayName is empty after cleaning, use initials or student ID
      if (!displayName || displayName === '') {
        displayName = initials || ('Student ' + studentId);
      }
      document.getElementById('welcome').textContent = `Welcome, Student : ${displayName}`;
      document.getElementById('student-id-line').textContent = studentId ? `ID: ${studentId}` : '';
      document.getElementById('avatar').textContent = initials || 'S';

      // Load advisor information
      await loadMyAdvisor(studentId);
      
      // Load advisors for dropdown
      await loadAdvisorsForDropdown(studentId);
      
      // Load student metrics and risk level
      await loadStudentMetrics(studentId);
      
      // Load student profile
      await loadStudentProfile(studentId);
      
      // Load financial information
      await loadFinancialData(studentId);
      
      // Note: Course enrollments and help requests will load when their tabs are opened
    });

    // Function to calculate risk level based on GPA and financial status
    function calculateRiskLevel(gpa, financialData = null) {
      let riskLevel = { level: 'success', text: 'No Risk', score: 0 };
      
      // Check GPA risk
      if (gpa >= 0 && gpa <= 2.9) {
        riskLevel = { level: 'danger', text: 'High', score: 30 };
      } else if (gpa >= 3.0 && gpa <= 3.2) {
        riskLevel = { level: 'warning', text: 'Medium Risk', score: 15 };
      } else if (gpa > 3.2) {
        riskLevel = { level: 'success', text: 'No Risk', score: 0 };
      } else {
        riskLevel = { level: 'info', text: 'Unknown', score: 0 };
      }
      
      // Check financial overdue risk (high priority - overrides GPA risk if overdue)
      if (financialData) {
        const daysOverdue = parseInt(financialData.days_overdue) || 0;
        const feeBalance = parseFloat(financialData.fee_balance) || 0;
        
        if (daysOverdue > 0) {
          // Financial overdue is high risk
          riskLevel = { level: 'danger', text: 'High', score: 50 };
        } else if (feeBalance > 5000) {
          // High fee balance is medium-high risk
          if (riskLevel.level === 'success') {
            riskLevel = { level: 'warning', text: 'Medium Risk', score: 20 };
          } else if (riskLevel.level === 'warning') {
            riskLevel = { level: 'danger', text: 'High', score: 40 };
          }
        }
      }
      
      return riskLevel;
    }

    async function loadStudentMetrics(studentId) {
      if (!studentId) {
        console.warn('No studentId provided for loadStudentMetrics');
        // Try to calculate risk from displayed GPA as fallback
        calculateRiskFromDisplayedGPA();
        return;
      }

      try {
        // Use the student profile endpoint which already has all the data merged
        const response = await fetch(`${window.location.origin}/api/data/students/${studentId}`);
        if (response.ok) {
          const student = await response.json();
          console.log('Loaded student data for metrics:', {
            studentId: student.studentId,
            academic: student.academic,
            financial: student.financial
          });
          
          const gpa = parseFloat(student.academic?.gpa) || 0;
          const credits = parseInt(student.academic?.creditsEarned) || parseInt(student.academic?.credits) || 0;
          const absences = parseInt(student.academic?.attendanceAbsences) || 0;
          const financialData = student.financial || {};
          
          // Calculate risk level
          const risk = calculateRiskLevel(gpa, financialData);
          console.log('Calculated risk level:', {
            gpa: gpa,
            financial: financialData,
            risk: risk
          });
          
          // Update GPA display
          const gpaElement = document.querySelector('.metrics-grid .metric .value');
          if (gpaElement && gpa > 0) {
            gpaElement.textContent = gpa.toFixed(2);
          }
          
          // Update credits display
          const creditsElements = document.querySelectorAll('.metrics-grid .metric .value');
          if (creditsElements.length > 1 && credits > 0) {
            creditsElements[1].textContent = `${credits}/120`;
          }
          
          // Calculate attendance percentage
          const attendanceElements = document.querySelectorAll('.metrics-grid .metric .value');
          if (attendanceElements.length > 2) {
            // Simple calculation: 100% - (absences * some factor)
            const attendancePercent = Math.max(0, Math.min(100, 100 - (absences * 2)));
            attendanceElements[2].textContent = `${Math.round(attendancePercent)}%`;
          }
          
          // Display risk level metric
          displayRiskMetric(risk);
        } else {
          console.error('Failed to load student data:', response.status);
          // Fallback: Calculate risk from displayed GPA
          calculateRiskFromDisplayedGPA();
        }
      } catch (error) {
        console.error('Error loading student metrics:', error);
        // Fallback: Calculate risk from displayed GPA
        calculateRiskFromDisplayedGPA();
      }
    }

    function calculateRiskFromDisplayedGPA() {
      // Fallback: Get GPA from the displayed value and calculate risk
      const gpaElement = document.querySelector('.metrics-grid .metric .value');
      if (gpaElement) {
        const displayedGPA = parseFloat(gpaElement.textContent);
        if (!isNaN(displayedGPA) && displayedGPA > 0) {
          // Try to get financial data if available
          let financialData = null;
          try {
            const daysOverdue = parseInt(document.getElementById('days-overdue')?.textContent) || 0;
            const feeBalanceText = document.getElementById('fee-balance')?.textContent || '';
            const feeBalance = parseFloat(feeBalanceText.replace(/[^0-9.]/g, '')) || 0;
            if (daysOverdue > 0 || feeBalance > 0) {
              financialData = {
                days_overdue: daysOverdue,
                fee_balance: feeBalance
              };
            }
          } catch (e) {
            console.log('Could not get financial data for risk calculation');
          }
          
          const risk = calculateRiskLevel(displayedGPA, financialData);
          console.log('Calculated risk from displayed GPA:', displayedGPA, 'Financial:', financialData, 'Risk:', risk);
          displayRiskMetric(risk);
          return;
        }
      }
      // If we can't get GPA, show unknown
      console.warn('Could not calculate risk level - GPA not available');
      displayRiskMetric({ level: 'info', text: 'Unknown' });
    }

    function displayRiskMetric(risk) {
      if (!risk) {
        console.warn('No risk data provided to displayRiskMetric');
        risk = { level: 'info', text: 'Unknown' };
      }
      
      const metricsContainer = document.querySelector('.metrics-grid');
      if (!metricsContainer) {
        console.error('Metrics container not found');
        return;
      }

      // Check if risk metric already exists
      let riskMetric = document.getElementById('risk-metric');
      if (!riskMetric) {
        // Create risk metric element
        riskMetric = document.createElement('div');
        riskMetric.id = 'risk-metric';
        riskMetric.className = 'metric';
        metricsContainer.appendChild(riskMetric);
      }

      // Update risk metric content
      riskMetric.innerHTML = `
        <div class="label">Risk Level</div>
        <div class="value" style="font-size: 16px; background-clip: unset; -webkit-background-clip: unset; -webkit-text-fill-color: unset; background: unset; margin-top: 8px;">
          <span class="chip ${risk.level}">${risk.text}</span>
        </div>
      `;
      
      console.log('Risk metric displayed:', risk);
    }

    let assignedAdvisorId = null;

    async function loadMyAdvisor(studentId) {
      if (!studentId) {
        document.getElementById('my-advisor').innerHTML = '<div class="list-item">No advisor assigned</div>';
        return;
      }

      try {
        const response = await fetch(`${window.location.origin}/api/data/students/${studentId}/advisor`);
        if (response.ok) {
          const advisor = await response.json();
          console.log('Advisor data received:', advisor);
          
          assignedAdvisorId = advisor.advisorId || advisor._id || advisor.id;
          
          // Update the hidden advisor field in the form
          const advisorSelect = document.getElementById('advisor-select');
          if (advisorSelect) {
            advisorSelect.value = assignedAdvisorId;
          }
          
          // Update the advisor display in the help request form
          loadAdvisorsForDropdown(studentId);
          
          // Ensure we have required fields
          const firstName = advisor.firstName || advisor.first_name || '';
          const lastName = advisor.lastName || advisor.last_name || '';
          const email = advisor.email || 'Not provided';
          const department = advisor.department || 'Unknown';
          const phone = advisor.phone || 'Not provided';
          
          if (!firstName && !lastName) {
            document.getElementById('my-advisor').innerHTML = '<div class="list-item">Advisor information incomplete</div>';
            return;
          }
          
          document.getElementById('my-advisor').innerHTML = `
            <div class="list-item">
              <span><strong>${firstName} ${lastName}</strong></span>
              <span class="chip">${department}</span>
            </div>
            <div class="list-item">
              <span>${email}</span>
              <span class="chip">Contact</span>
            </div>
            ${phone && phone !== 'Not provided' ? `
            <div class="list-item">
              <span>${phone}</span>
              <span class="chip">Phone</span>
            </div>
            ` : ''}
            <div class="list-item" style="margin-top: 8px; padding-top: 12px; border-top: 1px solid #e5e7eb;">
              <span style="font-size: 12px; color: #6b7280;">This is your assigned advisor from the system records</span>
            </div>
          `;
        } else {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('Failed to load advisor:', response.status, errorData);
          document.getElementById('my-advisor').innerHTML = '<div class="list-item">No advisor assigned. One will be assigned automatically.</div>';
        }
      } catch (error) {
        console.error('Error loading advisor:', error);
        document.getElementById('my-advisor').innerHTML = '<div class="list-item">Error loading advisor: ' + error.message + '</div>';
      }
    }

    async function loadAdvisorsForDropdown(studentId) {
      const advisorSelect = document.getElementById('advisor-select');
      const advisorDisplay = document.getElementById('assigned-advisor-display');
      
      if (!advisorSelect) return;

      // Wait for assigned advisor to be loaded
      if (!assignedAdvisorId) {
        // If not loaded yet, wait a bit and try again
        setTimeout(() => loadAdvisorsForDropdown(studentId), 500);
        return;
      }

      try {
        // Set the hidden field to the assigned advisor ID
        advisorSelect.value = assignedAdvisorId;
        
        // Fetch advisor details to display
        const response = await fetch(`${window.location.origin}/api/data/students/${studentId}/advisor`);
        if (response.ok) {
          const advisor = await response.json();
          const firstName = advisor.firstName || advisor.first_name || '';
          const lastName = advisor.lastName || advisor.last_name || '';
          const department = advisor.department || 'Unknown Department';
          
          if (advisorDisplay) {
            if (firstName || lastName) {
              advisorDisplay.textContent = `${firstName} ${lastName} (${department})`;
              advisorDisplay.style.color = '#1f2937';
            } else {
              advisorDisplay.textContent = 'Your assigned advisor';
              advisorDisplay.style.color = '#6b7280';
            }
          }
        } else {
          // Fallback: use the advisor ID we have
          if (advisorDisplay) {
            advisorDisplay.textContent = `Advisor ID: ${assignedAdvisorId}`;
            advisorDisplay.style.color = '#6b7280';
          }
        }
      } catch (error) {
        console.error('Error loading advisor details:', error);
        if (advisorDisplay) {
          advisorDisplay.textContent = 'Your assigned advisor will be notified';
          advisorDisplay.style.color = '#6b7280';
        }
      }
    }


    async function submitHelpRequest(e){
      e.preventDefault();
      const form = e.target;
      const selectedAdvisorId = form.advisorId.value || assignedAdvisorId;
      
      if (!selectedAdvisorId) {
        alert('No advisor assigned. Please contact the administration to assign an advisor.');
        return;
      }

      console.log('üìù Submitting help request...');
      console.log('   Assigned Advisor ID:', selectedAdvisorId);
      console.log('   Student ID:', localStorage.getItem('studentId'));

      const payload = {
        type: 'help-request',
        data: {
          category: form.category.value,
          subject: form.subject.value,
          details: form.details.value,
          urgency: form.urgency.value,
          studentId: localStorage.getItem('studentId') || null,
          fullName: localStorage.getItem('fullName') || null,
          email: localStorage.getItem('email') || null,
          advisorId: selectedAdvisorId // Include selected advisor ID
        }
      };
      
      console.log('üì§ Payload being sent:', payload);
      
      try{
        const res = await fetch(`${window.location.origin}/api/entries`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });
        
        const result = await res.json().catch(() => ({ error: 'Failed to parse response' }));
        
        if(!res.ok) {
          console.error('‚ùå Request failed:', res.status, result);
          throw new Error(result.error || 'Request failed');
        }
        
        console.log('‚úÖ Request submitted successfully:', result);
        console.log('   Notification created:', result.notificationCreated);
        console.log('   Notification data:', result.notification);
        
        form.reset();
        // Reset advisor selection to assigned advisor
        if (assignedAdvisorId) {
          form.advisorId.value = assignedAdvisorId;
          // Reload advisor display
          loadAdvisorsForDropdown(localStorage.getItem('studentId'));
        }
        
        // Show success message with notification status
        if (result.notificationCreated) {
          alert(`‚úÖ Request submitted successfully!\n\nYour request has been saved and your advisor (${result.notification?.advisorName || 'advisor'}) has been notified. They will see it in their dashboard and will reach out soon.`);
        } else {
          alert(`‚úÖ Request submitted successfully!\n\nYour request has been saved. ${result.message || 'Your advisor will be notified shortly.'}`);
        }
        
        // Close the form after successful submission
        toggleHelpRequestForm();
        
        // Reload help requests to show the new one
        await loadHelpRequests(localStorage.getItem('studentId'));
      } catch(err){
        console.error('‚ùå Error submitting request:', err);
        alert('Failed to submit. Please try again. Error: ' + err.message);
      }
    }

    async function loadFinancialData(studentId) {
      if (!studentId) {
        console.warn('No studentId provided for loadFinancialData');
        return;
      }

      try {
        const response = await fetch(`${window.location.origin}/api/data/students/${studentId}`);
        if (!response.ok) {
          throw new Error('Failed to load financial data');
        }
        const student = await response.json();
        
        const financial = student.financial || {};
        // Handle both fee_balance (CSV) and feeBalance (MongoDB) field names
        const feeBalance = parseFloat(financial.fee_balance || financial.feeBalance || 0);
        const financialAidStatus = financial.financial_aid_status || financial.financialAidStatus || 'No Financial Aid';
        // Handle both days_overdue (CSV) and daysOverdue (MongoDB) field names
        const daysOverdue = parseInt(financial.days_overdue || financial.daysOverdue || 0);
        const lastPaymentDate = financial.last_payment_date || financial.lastPaymentDate || 'Not available';
        
        console.log('Financial data from API:', financial);
        console.log('Parsed financial values:', { feeBalance, financialAidStatus, daysOverdue, lastPaymentDate });
        
        // Show financial card
        const financialCard = document.getElementById('financial-card');
        if (financialCard) {
          financialCard.style.display = 'block';
        }
        
        // Display fee balance
        const feeBalanceElement = document.getElementById('fee-balance');
        if (feeBalanceElement) {
          feeBalanceElement.textContent = `$${feeBalance.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }
        
        // Display balance chip
        const balanceChip = document.getElementById('balance-chip');
        if (balanceChip) {
          if (feeBalance === 0) {
            balanceChip.textContent = 'Paid';
            balanceChip.className = 'chip success';
          } else if (feeBalance < 1000) {
            balanceChip.textContent = 'Low';
            balanceChip.className = 'chip info';
          } else if (feeBalance < 5000) {
            balanceChip.textContent = 'Medium';
            balanceChip.className = 'chip warning';
          } else {
            balanceChip.textContent = 'High';
            balanceChip.className = 'chip danger';
          }
        }
        
        // Display financial aid status
        const aidStatusElement = document.getElementById('aid-status');
        if (aidStatusElement) {
          aidStatusElement.textContent = financialAidStatus;
        }
        
        // Display aid chip
        const aidChip = document.getElementById('aid-chip');
        if (aidChip) {
          if (financialAidStatus === 'On Financial Aid') {
            aidChip.textContent = 'Active';
            aidChip.className = 'chip success';
          } else {
            aidChip.textContent = 'None';
            aidChip.className = 'chip';
          }
        }
        
        // Display last payment date
        const lastPaymentElement = document.getElementById('last-payment');
        if (lastPaymentElement) {
          if (lastPaymentDate && lastPaymentDate !== 'Not available') {
            // Format date if it's a valid date string
            try {
              const date = new Date(lastPaymentDate);
              if (!isNaN(date.getTime())) {
                lastPaymentElement.textContent = date.toLocaleDateString('en-US', { 
                  year: 'numeric', 
                  month: 'short', 
                  day: 'numeric' 
                });
              } else {
                lastPaymentElement.textContent = lastPaymentDate;
              }
            } catch (e) {
              lastPaymentElement.textContent = lastPaymentDate;
            }
          } else {
            lastPaymentElement.textContent = 'Not available';
          }
        }
        
        // Display overdue information if applicable
        const overdueItem = document.getElementById('overdue-item');
        const daysOverdueElement = document.getElementById('days-overdue');
        if (daysOverdue > 0) {
          if (overdueItem) {
            overdueItem.style.display = 'flex';
          }
          if (daysOverdueElement) {
            daysOverdueElement.textContent = `${daysOverdue} days`;
          }
        } else {
          if (overdueItem) {
            overdueItem.style.display = 'none';
          }
        }
        
        console.log('Financial data loaded:', {
          feeBalance,
          financialAidStatus,
          daysOverdue,
          lastPaymentDate
        });
        
        // Update risk level based on financial data
        const gpaElement = document.querySelector('.metrics-grid .metric .value');
        if (gpaElement) {
          const displayedGPA = parseFloat(gpaElement.textContent);
          if (!isNaN(displayedGPA) && displayedGPA > 0) {
            const financialData = {
              days_overdue: daysOverdue,
              fee_balance: feeBalance
            };
            const risk = calculateRiskLevel(displayedGPA, financialData);
            console.log('Updating risk level with financial data:', { displayedGPA, financialData, risk });
            displayRiskMetric(risk);
          }
        }
      } catch (error) {
        console.error('Error loading financial data:', error);
        // Hide financial card on error
        const financialCard = document.getElementById('financial-card');
        if (financialCard) {
          financialCard.style.display = 'none';
        }
      }
    }

    // Store enrollment data globally for filtering
    let enrollmentData = null;

    async function loadEnrollments(studentId) {
      if (!studentId) {
        console.warn('No studentId provided for loadEnrollments');
        return;
      }

      try {
        console.log('üìö Loading enrollments for student:', studentId);
        const response = await fetch(`${window.location.origin}/api/data/students/${studentId}/enrollments`);
        if (!response.ok) {
          throw new Error('Failed to load enrollments');
        }
        const data = await response.json();
        
        console.log('‚úÖ Enrollment data received:', data);
        
        // Store enrollment data globally
        enrollmentData = data;
        
        const container = document.getElementById('enrollments-container');
        const termSelect = document.getElementById('term-select');
        
        if (!container || !termSelect) {
          console.error('‚ùå Enrollments container or term select not found');
          return;
        }
        
        if (!data.terms || data.terms.length === 0) {
          container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No enrollments found.</div>';
          termSelect.innerHTML = '<option value="">No terms available</option>';
          return;
        }
        
        // Populate term dropdown
        termSelect.innerHTML = '<option value="">Select a Term</option>';
        data.terms.forEach(termGroup => {
          const term = termGroup.term;
          if (term) {
            const option = document.createElement('option');
            option.value = term.term_id || term.termId;
            const termName = term.term_name || term.termName || `Term ${term.term_id || term.termId}`;
            const academicYear = term.academic_year || term.academicYear;
            option.textContent = `${termName}${academicYear ? ` (${academicYear})` : ''}`;
            termSelect.appendChild(option);
          }
        });
        
        // Remove existing event listeners and add new one
        const newTermSelect = termSelect.cloneNode(true);
        termSelect.parentNode.replaceChild(newTermSelect, termSelect);
        newTermSelect.addEventListener('change', function() {
          displayEnrollments(this.value);
        });
        
        // Show empty container initially (user must select a term)
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Please select a term from the dropdown above to view your course enrollments.</div>';
        
        console.log('‚úÖ Enrollments loaded:', {
          totalEnrollments: data.totalEnrollments,
          terms: data.terms.length
        });
      } catch (error) {
        console.error('‚ùå Error loading enrollments:', error);
        const container = document.getElementById('enrollments-container');
        if (container) {
          container.innerHTML = '<div style="text-align: center; padding: 20px; color: #dc2626;">Error loading enrollments. Please try again later.</div>';
        }
      }
    }

    function displayEnrollments(selectedTermId) {
      if (!enrollmentData || !enrollmentData.terms) {
        return;
      }
      
      const container = document.getElementById('enrollments-container');
      if (!container) {
        return;
      }
      
      // If no term selected, show empty
      if (!selectedTermId || selectedTermId === '') {
        container.innerHTML = '';
        return;
      }
      
      // Filter terms based on selection
      const termsToDisplay = enrollmentData.terms.filter(termGroup => {
        const termId = termGroup.term?.term_id || termGroup.term?.termId;
        return termId == selectedTermId || termId === selectedTermId || String(termId) === String(selectedTermId);
      });
      
      if (termsToDisplay.length === 0) {
        container.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No enrollments found for selected term.</div>';
        return;
      }
      
      // Calculate total enrollments for displayed term
      const displayedTotal = termsToDisplay.reduce((sum, termGroup) => sum + termGroup.enrollments.length, 0);
      
      // Build HTML for enrollments grouped by term
      let html = `<div style="margin-bottom: 8px; color: #666; font-size: 14px;">Showing <strong>${displayedTotal}</strong> course${displayedTotal !== 1 ? 's' : ''} for selected term</div>`;
      
      termsToDisplay.forEach(termGroup => {
        const term = termGroup.term;
        const enrollments = termGroup.enrollments;
        
        if (!term) {
          return;
        }
        
        html += `
          <div class="term-group" data-term-id="${term.term_id}" style="margin-bottom: 24px; padding-bottom: 20px; border-bottom: 2px solid #e8ecf2;">
            <h3 style="font-size: 16px; margin-bottom: 12px; color: #333; display: flex; align-items: center; gap: 8px;">
              <span>${term.term_name || `Term ${term.term_id}`}</span>
              ${term.academic_year ? `<span style="font-size: 12px; color: #666; font-weight: normal;">(${term.academic_year})</span>` : ''}
              <span class="chip" style="margin-left: auto;">${enrollments.length} course${enrollments.length !== 1 ? 's' : ''}</span>
            </h3>
            ${term.start_date && term.end_date ? `
              <div style="font-size: 12px; color: #666; margin-bottom: 12px;">
                ${new Date(term.start_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })} - 
                ${new Date(term.end_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
              </div>
            ` : ''}
            <div class="list" style="gap: 8px;">
        `;
        
        enrollments.forEach(enrollment => {
          const course = enrollment.course;
          const grade = enrollment.grade;
          const status = enrollment.status;
          const enrolledDate = enrollment.enrolled_date ? new Date(enrollment.enrolled_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }) : 'N/A';
          
          // Determine status chip color
          let statusChipClass = 'chip';
          if (status === 'Completed') {
            statusChipClass = 'chip success';
          } else if (status === 'In Progress') {
            statusChipClass = 'chip info';
          } else if (status === 'Dropped' || status === 'Withdrawn') {
            statusChipClass = 'chip danger';
          }
          
          // Determine grade chip color
          let gradeChipClass = 'chip';
          if (grade && grade !== 'IP' && grade !== 'N/A') {
            const gradeNum = parseFloat(grade);
            if (!isNaN(gradeNum)) {
              if (gradeNum >= 3.5) {
                gradeChipClass = 'chip success';
              } else if (gradeNum >= 2.5) {
                gradeChipClass = 'chip warning';
              } else {
                gradeChipClass = 'chip danger';
              }
            }
          }
          
          html += `
            <div class="list-item" style="padding: 14px;">
              <div style="flex: 1;">
                <div style="font-weight: 600; margin-bottom: 4px; color: #333;">
                  ${course ? `${course.course_code || ''} - ${course.course_title || 'Unknown Course'}` : `Course ID: ${enrollment.course_id}`}
                </div>
                <div style="font-size: 12px; color: #666; margin-bottom: 6px;">
                  ${course ? `Credits: ${course.credits || 0} | Department: ${course.department || 'Unknown'}` : ''}
                </div>
                <div style="font-size: 12px; color: #999;">
                  Enrolled: ${enrolledDate}
                </div>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span class="${gradeChipClass}">Grade: ${grade || 'N/A'}</span>
                <span class="${statusChipClass}">${status || 'Unknown'}</span>
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }

    async function loadStudentProfile(studentId) {
      try {
        const response = await fetch(`${window.location.origin}/api/data/students/${studentId}`);
        if (!response.ok) {
          throw new Error('Failed to load profile');
        }
        const student = await response.json();
        
        console.log('Student profile data received:', {
          studentId: student.studentId,
          firstName: student.firstName,
          lastName: student.lastName,
          email: student.email,
          phone: student.phone,
          major: student.major,
          year: student.year,
          advisor_id: student.advisor_id
        });
        
        // If critical data is missing, try to sync with CSV
        if ((!student.phone || student.phone === 'Not provided') && studentId) {
          console.log('Student phone missing, attempting to sync with CSV...');
          try {
            const syncResponse = await fetch(`${window.location.origin}/api/data/sync-student/${studentId}`, {
              method: 'POST'
            });
            if (syncResponse.ok) {
              const syncedData = await syncResponse.json();
              console.log('Student data synced:', syncedData);
              // Reload profile after sync
              return loadStudentProfile(studentId);
            }
          } catch (syncError) {
            console.error('Error syncing student data:', syncError);
          }
        }
        
        // Display profile information - use CSV data as source of truth
        document.getElementById('profile-name').textContent = `${student.firstName || ''} ${student.lastName || ''}`.trim() || 'Not provided';
        document.getElementById('profile-email').textContent = student.email || 'Not provided';
        document.getElementById('profile-phone').textContent = (student.phone && student.phone !== 'Not provided' && student.phone.trim() !== '') ? student.phone : 'Not provided';
        document.getElementById('profile-major').textContent = student.major || 'Not provided';
        document.getElementById('profile-year').textContent = student.year || 'Not provided';
        
        // Format address
        const addr = student.address || {};
        const addressParts = [];
        if (addr.street) addressParts.push(addr.street);
        if (addr.city) addressParts.push(addr.city);
        if (addr.state) addressParts.push(addr.state);
        if (addr.zipCode) addressParts.push(addr.zipCode);
        if (addr.country) addressParts.push(addr.country);
        document.getElementById('profile-address').textContent = addressParts.length > 0 ? addressParts.join(', ') : 'Not provided';
        
        // Populate edit form
        document.getElementById('edit-name').value = `${student.firstName} ${student.lastName}`;
        document.getElementById('edit-email').value = student.email || '';
        document.getElementById('edit-phone').value = student.phone || '';
        document.getElementById('edit-major').value = student.major || '';
        document.getElementById('edit-year').value = student.year || 'First Year';
        document.getElementById('edit-address-street').value = addr.street || '';
        document.getElementById('edit-address-city').value = addr.city || '';
        document.getElementById('edit-address-state').value = addr.state || '';
        document.getElementById('edit-address-zip').value = addr.zipCode || '';
        document.getElementById('edit-address-country').value = addr.country || 'USA';
      } catch (error) {
        console.error('Error loading student profile:', error);
        document.getElementById('profile-name').textContent = 'Error loading profile';
      }
    }

    function toggleHelpRequestForm() {
      const helpRequestCard = document.getElementById('help-request-card');
      if (helpRequestCard) {
        if (helpRequestCard.style.display === 'none' || helpRequestCard.style.display === '') {
          helpRequestCard.style.display = 'block';
          // Scroll to the form
          helpRequestCard.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        } else {
          helpRequestCard.style.display = 'none';
        }
      }
    }

    async function loadHelpRequests(studentId) {
      const requestsList = document.getElementById('help-requests-list');
      if (!requestsList) return;

      try {
        console.log('üìã Loading help requests for student:', studentId);
        const response = await fetch(`${window.location.origin}/api/entries?studentId=${studentId}&type=help-request&includeReplies=true`);
        
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
          console.error('‚ùå Failed to load help requests:', response.status, errorData);
          throw new Error(errorData.error || `Failed to load help requests (${response.status})`);
        }

        const requests = await response.json();
        console.log('‚úÖ Loaded help requests:', requests.length);

        if (requests.length === 0) {
          requestsList.innerHTML = '<div class="list-item" style="text-align: center; color: #6b7280; padding: 20px;">No help requests yet. Click "Contact Advisor" to submit a request.</div>';
          return;
        }

        requestsList.innerHTML = requests.map(request => {
          const date = new Date(request.createdAt);
          const dateStr = date.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          const hasReply = request.reply && request.reply.contactMethod;
          const replyDate = hasReply && request.reply.repliedAt ? new Date(request.reply.repliedAt) : null;
          const replyDateStr = replyDate ? replyDate.toLocaleDateString('en-US', { 
            year: 'numeric', 
            month: 'short', 
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          }) : '';
          
          console.log('Request:', {
            id: request._id,
            subject: request.data?.subject,
            hasReply: hasReply,
            reply: request.reply
          });
          
          return `
            <div style="margin-bottom: 20px; border: 2px solid ${hasReply ? '#22c55e' : '#e5e7eb'}; border-radius: 12px; overflow: hidden; background: #fff;">
              <!-- Your Request Section -->
              <div style="padding: 16px; background: ${hasReply ? '#f9fafb' : '#fff'}; border-bottom: ${hasReply ? '2px solid #e5e7eb' : 'none'};">
                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                  <div style="flex: 1;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                      <span style="font-size: 11px; font-weight: 600; color: #6b7280; text-transform: uppercase;">Your Request</span>
                      <span class="chip" style="background: #e0e7ff; color: #3730a3; font-size: 11px;">${escapeHtml(request.data?.category || 'General')}</span>
                      <span class="chip" style="background: ${request.data?.urgency === 'High' ? '#fee2e2' : request.data?.urgency === 'Normal' ? '#fef3c7' : '#d1fae5'}; color: ${request.data?.urgency === 'High' ? '#991b1b' : request.data?.urgency === 'Normal' ? '#92400e' : '#166534'}; font-size: 11px;">${escapeHtml(request.data?.urgency || 'Normal')}</span>
                    </div>
                    <div style="font-weight: 600; color: #1f2937; margin-bottom: 4px; font-size: 15px;">${escapeHtml(request.data?.subject || 'No Subject')}</div>
                    <div style="font-size: 12px; color: #6b7280;">Submitted: ${dateStr}</div>
                  </div>
                </div>
                <div style="font-size: 13px; color: #374151; line-height: 1.6; white-space: pre-wrap; padding: 12px; background: #fff; border-radius: 8px; border: 1px solid #e5e7eb;">
                  ${escapeHtml(request.data?.details || 'No details provided')}
                </div>
              </div>
              
              <!-- Advisor Reply Section -->
              ${hasReply ? `
                <div style="padding: 16px; background: #f0fdf4; border-top: 3px solid #22c55e;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 12px;">
                    <span style="font-size: 20px;">‚úì</span>
                    <span style="font-size: 13px; font-weight: 600; color: #166534; text-transform: uppercase;">Reply from Your Advisor</span>
                    ${replyDateStr ? `<span style="font-size: 11px; color: #6b7280; margin-left: auto;">${replyDateStr}</span>` : ''}
                  </div>
                  <div style="background: #fff; padding: 14px; border-radius: 8px; border-left: 3px solid #22c55e;">
                    <div style="font-size: 13px; color: #15803d; line-height: 1.8;">
                      <div style="margin-bottom: 8px;">
                        <strong style="color: #166534;">Contact Method:</strong> 
                        <span style="color: #374151;">${escapeHtml(request.reply.contactMethod)}</span>
                      </div>
                      <div style="margin-bottom: 8px;">
                        <strong style="color: #166534;">When:</strong> 
                        <span style="color: #374151;">${escapeHtml(request.reply.timing)}</span>
                      </div>
                      ${request.reply.message ? `
                        <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid #bbf7d0;">
                          <strong style="color: #166534; display: block; margin-bottom: 6px;">Message:</strong>
                          <div style="color: #374151; white-space: pre-wrap; line-height: 1.6;">${escapeHtml(request.reply.message)}</div>
                        </div>
                      ` : ''}
                    </div>
                  </div>
                </div>
              ` : `
                <div style="padding: 16px; background: #fff; text-align: center;">
                  <div style="font-size: 13px; color: #6b7280; font-style: italic; display: flex; align-items: center; justify-content: center; gap: 8px;">
                    <span>‚è≥</span>
                    <span>Waiting for advisor response...</span>
                  </div>
                </div>
              `}
            </div>
          `;
        }).join('');
      } catch (error) {
        console.error('‚ùå Error loading help requests:', error);
        console.error('Error details:', {
          message: error.message,
          stack: error.stack,
          studentId: studentId
        });
        
        // Show more helpful error message
        const errorMsg = error.message || 'Unknown error occurred';
        requestsList.innerHTML = `
          <div class="list-item" style="color: #dc2626; padding: 16px; text-align: center;">
            <div style="margin-bottom: 8px;">‚ö†Ô∏è Error loading help requests</div>
            <div style="font-size: 12px; color: #6b7280; margin-bottom: 12px;">${escapeHtml(errorMsg)}</div>
            <button class="btn primary" onclick="loadHelpRequests('${studentId}')" style="padding: 8px 16px; font-size: 13px;">
              Try Again
            </button>
          </div>
        `;
      }
    }

    function toggleProfileEdit() {
      const display = document.getElementById('profile-display');
      const edit = document.getElementById('profile-edit');
      const btn = document.getElementById('edit-profile-btn');
      
      if (edit.style.display === 'none') {
        display.style.display = 'none';
        edit.style.display = 'block';
        btn.textContent = 'View Profile';
      } else {
        display.style.display = 'block';
        edit.style.display = 'none';
        btn.textContent = 'Edit Profile';
        // Reload profile to reset form
        const studentId = localStorage.getItem('studentId');
        if (studentId) loadStudentProfile(studentId);
      }
    }

    async function saveProfile(event) {
      event.preventDefault();
      const studentId = localStorage.getItem('studentId');
      if (!studentId) {
        alert('Student ID not found. Please log in again.');
        return;
      }

      try {
        const form = event.target;
        const formData = {
          phone: document.getElementById('edit-phone').value,
          major: document.getElementById('edit-major').value,
          year: document.getElementById('edit-year').value,
          address: {
            street: document.getElementById('edit-address-street').value,
            city: document.getElementById('edit-address-city').value,
            state: document.getElementById('edit-address-state').value,
            zipCode: document.getElementById('edit-address-zip').value,
            country: document.getElementById('edit-address-country').value
          }
        };

        const response = await fetch(`${window.location.origin}/api/auth/student/profile/${studentId}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(formData)
        });

        const result = await response.json();

        if (!response.ok || !result.success) {
          throw new Error(result.error || 'Failed to update profile');
        }

        alert('Profile updated successfully!');
        toggleProfileEdit();
        await loadStudentProfile(studentId);
      } catch (error) {
        console.error('Error saving profile:', error);
        alert('Failed to update profile. Please try again. Error: ' + error.message);
      }
    }
  </script>
  </head>
<body>
  <canvas id="particle-canvas" style="position:fixed;inset:0;pointer-events:none;z-index:9998;"></canvas>
  <div class="dashboard">
    <div class="header">
      <div class="title">
        <div id="avatar" class="avatar">S</div>
        <div>
          <h1 id="welcome">Welcome</h1>
          <div id="student-id-line" class="meta"></div>
          <small>Student Dashboard</small>
        </div>
      </div>
      <a class="signout" href="index.html" onclick="
        localStorage.clear();
        sessionStorage.clear();
        // Prevent back button access
        window.location.replace('index.html');
        return false;
      ">Sign out</a>
    </div>

    <!-- Navigation Tabs -->
    <div class="nav-tabs">
      <button class="nav-tab active" data-tab="overview">üìä Overview</button>
      <button class="nav-tab" data-tab="courses">üìö Courses</button>
      <button class="nav-tab" data-tab="profile">üë§ Profile</button>
      <button class="nav-tab" data-tab="advisor">üë®‚Äçüè´ My Advisor</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="grid">
        <div class="left-column">
          <!-- Academic Metrics Section -->
          <div class="card">
            <h2>Academic Metrics</h2>
            <div class="metrics-grid">
              <div class="metric">
                <div class="label">GPA</div>
                <div class="value">3.8</div>
              </div>
              <div class="metric">
                <div class="label">Credits</div>
                <div class="value">72/120</div>
              </div>
              <div class="metric">
                <div class="label">Attendance</div>
                <div class="value">95%</div>
              </div>
              <div class="metric" id="risk-metric">
                <div class="label">Risk Level</div>
                <div class="value" style="font-size: 16px; background-clip: unset; -webkit-background-clip: unset; -webkit-text-fill-color: unset; background: unset; margin-top: 8px;">
                  <span class="chip info">Loading...</span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="right-column">
          <!-- Financial Information -->
          <div class="card" id="financial-card">
            <h2>Financial Information</h2>
            <div class="list" id="financial-info">
              <div class="list-item">
                <span><strong>Fee Balance:</strong> <span id="fee-balance">Loading...</span></span>
                <span class="chip" id="balance-chip">-</span>
              </div>
              <div class="list-item">
                <span><strong>Financial Aid Status:</strong> <span id="aid-status">Loading...</span></span>
                <span class="chip" id="aid-chip">-</span>
              </div>
              <div class="list-item">
                <span><strong>Last Payment Date:</strong> <span id="last-payment">Loading...</span></span>
              </div>
              <div class="list-item" id="overdue-item" style="display: none;">
                <span><strong>Days Overdue:</strong> <span id="days-overdue" style="color: #dc2626; font-weight: 600;">0</span></span>
                <span class="chip danger">Overdue</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Courses Tab -->
    <div id="courses" class="tab-content">
      <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
          <h2 style="margin: 0; border: none; padding: 0;">Course Enrollments</h2>
          <select id="term-select" style="padding: 8px 12px; border: 2px solid #e8ecf2; border-radius: 8px; font-size: 14px; background: #fff; cursor: pointer;">
            <option value="">Select a Term</option>
          </select>
        </div>
        <div id="enrollments-container">
          <div style="text-align: center; padding: 20px; color: #666;">Please select a term from the dropdown above to view your course enrollments.</div>
        </div>
      </div>
    </div>

    <!-- Profile Tab -->
    <div id="profile" class="tab-content">
      <div class="card">
        <h2>My Profile</h2>
        <div id="profile-section">
          <button id="edit-profile-btn" class="btn secondary" style="width: 100%; margin-bottom: 12px;" onclick="toggleProfileEdit()">Edit Profile</button>
          <div id="profile-display">
            <div class="list-item"><strong>Name:</strong> <span id="profile-name">Loading...</span></div>
            <div class="list-item"><strong>Email:</strong> <span id="profile-email">Loading...</span></div>
            <div class="list-item"><strong>Phone:</strong> <span id="profile-phone">Loading...</span></div>
            <div class="list-item"><strong>Major:</strong> <span id="profile-major">Loading...</span></div>
            <div class="list-item"><strong>Year:</strong> <span id="profile-year">Loading...</span></div>
            <div class="list-item"><strong>Address:</strong> <span id="profile-address">Loading...</span></div>
          </div>
          <div id="profile-edit" style="display: none;">
            <form class="form" id="profile-edit-form" onsubmit="saveProfile(event)">
              <div>
                <label>Name (cannot be changed)</label>
                <input type="text" id="edit-name" disabled style="background: #f3f4f6; cursor: not-allowed;" />
              </div>
              <div>
                <label>Email (cannot be changed)</label>
                <input type="email" id="edit-email" disabled style="background: #f3f4f6; cursor: not-allowed;" />
              </div>
              <div>
                <label for="edit-phone">Phone</label>
                <input type="tel" id="edit-phone" name="phone" placeholder="Enter phone number" />
              </div>
              <div>
                <label for="edit-major">Major</label>
                <input type="text" id="edit-major" name="major" placeholder="Enter major" />
              </div>
              <div>
                <label for="edit-year">Year</label>
                <select id="edit-year" name="year">
                  <option value="First Year">First Year</option>
                  <option value="Second Year">Second Year</option>
                  <option value="Third Year">Third Year</option>
                  <option value="Fourth Year">Fourth Year</option>
                  <option value="Graduate">Graduate</option>
                </select>
              </div>
              <div>
                <label for="edit-address-street">Street Address</label>
                <input type="text" id="edit-address-street" name="address.street" placeholder="Enter street address" />
              </div>
              <div class="row">
                <div>
                  <label for="edit-address-city">City</label>
                  <input type="text" id="edit-address-city" name="address.city" placeholder="City" />
                </div>
                <div>
                  <label for="edit-address-state">State</label>
                  <input type="text" id="edit-address-state" name="address.state" placeholder="State" />
                </div>
              </div>
              <div class="row">
                <div>
                  <label for="edit-address-zip">Zip Code</label>
                  <input type="text" id="edit-address-zip" name="address.zipCode" placeholder="Zip Code" />
                </div>
                <div>
                  <label for="edit-address-country">Country</label>
                  <input type="text" id="edit-address-country" name="address.country" placeholder="Country" value="USA" />
                </div>
              </div>
              <div class="actions">
                <button type="button" class="btn secondary" onclick="toggleProfileEdit()">Cancel</button>
                <button type="submit" class="btn primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- My Advisor Tab -->
    <div id="advisor" class="tab-content">
      <div class="grid">
        <div class="left-column">
          <!-- Advisor Section -->
          <div class="card">
            <h2>My Advisor</h2>
            <div id="my-advisor" class="list">
              <div class="loading">Loading advisor information...</div>
            </div>
            <button type="button" class="btn primary" onclick="toggleHelpRequestForm()" style="width: 100%; margin-top: 16px; padding: 12px;">
              Contact Advisor
            </button>
          </div>

          <!-- Help Request Form (Hidden by default) -->
          <div class="card" id="help-request-card" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <h2 style="margin: 0; border: none; padding: 0;">Help Request</h2>
              <button type="button" class="btn secondary" onclick="toggleHelpRequestForm()" style="padding: 8px 16px; font-size: 14px;">Close</button>
            </div>
            <form class="form" id="help-request-form" onsubmit="submitHelpRequest(event)">
              <div class="row">
                <div>
                  <label for="category">Category</label>
                  <select id="category" name="category" required>
                    <option value="">Select category</option>
                    <option>Housing</option>
                    <option>Academics</option>
                    <option>Classes</option>
                    <option>Financial</option>
                    <option>Health & Wellness</option>
                    <option>Other</option>
                  </select>
                </div>
                <div>
                  <label for="urgency">Urgency</label>
                  <select id="urgency" name="urgency" required>
                    <option>Low</option>
                    <option>Normal</option>
                    <option>High</option>
                  </select>
                </div>
              </div>
              <input type="hidden" id="advisor-select" name="advisorId" value="">
              <div style="padding: 12px; background: #f3f4f6; border-radius: 8px; margin-bottom: 16px;">
                <div style="font-size: 13px; color: #6b7280; margin-bottom: 4px;">Your request will be sent to:</div>
                <div id="assigned-advisor-display" style="font-weight: 600; color: #1f2937;">Loading your assigned advisor...</div>
              </div>
              <div>
                <label for="subject">Subject</label>
                <input id="subject" name="subject" placeholder="Brief summary" required />
              </div>
              <div>
                <label for="details">Details</label>
                <textarea id="details" name="details" placeholder="Describe the issue..." required></textarea>
              </div>
              <div class="actions">
                <button type="reset" class="btn secondary">Clear</button>
                <button type="submit" class="btn primary">Submit Request</button>
              </div>
            </form>
          </div>
        </div>

        <div class="right-column">
          <!-- My Help Requests Section -->
          <div class="card">
            <h2>My Help Requests</h2>
            <div id="help-requests-list" class="list">
              <div class="loading">Loading your help requests...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <script>
    // Tab navigation event listeners (after DOM is loaded)
    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => {
          const tabId = tab.getAttribute('data-tab');
          switchTab(tabId);
        });
      });
    });
  </script>
</body>
</html>


